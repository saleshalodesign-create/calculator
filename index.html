<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Halo Design Hub Pricing</title>
    <meta name="description" content="Professional signage and lighting pricing calculator for Halo Design Hub." />
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', '"Microsoft YaHei"', '"PingFang SC"', '"Heiti SC"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
              mono: ['"Space Mono"', 'monospace'],
            },
            colors: {
              halo: { green: '#C1D82F', dark: '#1f2937' },
              dark: { bg: '#09090b', surface: '#18181b', surfaceHover: '#27272a', border: '#27272a', borderHover: '#3f3f46', text: '#f4f4f5', muted: '#a1a1aa' }
            },
            animation: {
              blob: "blob 7s infinite",
              "spin-slow": "spin-slow 12s linear infinite",
              "breathe": "breathe 3s ease-in-out infinite",
              "gradient-x": "gradient-x 3s ease infinite",
              "fade-in": "fadeIn 0.3s ease-out forwards",
              "ripple": "ripple 0.8s linear forwards",
              "shake": "shake 0.25s ease-in-out infinite",
            },
            keyframes: {
              blob: { "0%": { transform: "translate(0px, 0px) scale(1)" }, "33%": { transform: "translate(30px, -50px) scale(1.1)" }, "66%": { transform: "translate(-20px, 20px) scale(0.9)" }, "100%": { transform: "translate(0px, 0px) scale(1)" } },
              "spin-slow": { "0%": { transform: "rotate(0deg)" }, "100%": { transform: "rotate(360deg)" } },
              "breathe": { "0%, 100%": { transform: "scale(1)" }, "50%": { transform: "scale(0.85)" } },
              "gradient-x": { "0%, 100%": { "background-size": "200% 200%", "background-position": "left center" }, "50%": { "background-size": "200% 200%", "background-position": "right center" } },
              fadeIn: { "0%": { opacity: "0", transform: "translateY(10px)" }, "100%": { opacity: "1", transform: "translateY(0)" } },
              ripple: { "0%": { transform: "scale(0)", opacity: "0.8" }, "100%": { transform: "scale(4)", opacity: "0" } },
              shake: { "0%, 100%": { transform: "rotate(-1.5deg)" }, "50%": { transform: "rotate(1.5deg)" } }
            },
            boxShadow: { 'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)', 'glass-hover': '0 20px 40px 0 rgba(31, 38, 135, 0.15)' }
          }
        }
      }
    </script>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", "PingFang SC", Roboto, Helvetica, Arial, sans-serif; }
      @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }
      .perspective-1000 { perspective: 1000px; }
      .bg-noise { background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E"); mix-blend-mode: overlay; pointer-events: none; }
      .text-3d { text-shadow: 0px 1px 2px rgba(0,0,0,0.15); }
      html.dark .text-3d { text-shadow: 0px 2px 4px rgba(0,0,0,0.8); }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(156, 163, 175, 0.8); }
      html.dark .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); }
      html.dark .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }
      .watermark-container::before { content: "HALO"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 8rem; font-weight: 900; opacity: 0.03; pointer-events: none; z-index: 0; white-space: nowrap; }
      @media (max-width: 768px) { 
        .animate-blob { animation: none !important; } 
        .animate-breathe { animation: none !important; } 
        .animate-spin-slow { animation: none !important; } 
        .animate-gradient-x { display: none !important; } 
        [class*="backdrop-blur"]:not([class*="active"]) { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; } 
      }
      .animate-ripple { animation: ripple 0.8s linear forwards !important; }
      .animate-fade-in { animation: fadeIn 0.3s ease-out forwards !important; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
<body class="bg-sky-50 dark:bg-dark-bg text-gray-900 dark:text-dark-text min-h-screen selection:bg-sky-300 selection:text-black flex flex-col overflow-x-hidden transition-colors duration-500">
    <div id="root" class="w-full min-h-screen flex flex-col relative z-10"></div>

    <script type="text/babel" data-presets="typescript,react">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        /* --- TYPES & CONSTANTS --- */
        const Unit = { IN: 'in', FT: 'ft', CM: 'cm', MM: 'mm' };
        const Theme = { LIGHT: 'light', DARK: 'dark' };

        const RATES = {
            LIGHTBOX_W_BACKLIT: 85,
            LIGHTBOX_ONLY: 50,
            BACKLIT_ONLY: 35,
            BACKLIT_ACRYLIC: 50,
            TRANS_ONLY: 45,
            TRANS_ACRYLIC: 60,
            VINYL_ECO: 15,
            VINYL_STD: 20,
            VINYL_PREM: 25,
            ACRYLIC: 15,
            PRINTED_3D: 120,
        };

        const LED_STRIP_DIVISOR_W = 39;
        const LED_STRIP_DIVISOR_H = 5;
        const LED_STRIP_MULTIPLIER = 17;

        const PRESET_ITEMS = [
            { name: 'LAMINATED A3 MENU', price: 35 },
            { name: 'LAMINATED A4 MENU', price: 25 },
            { name: 'STANDARD BANNER', price: 80 },
            { name: 'A1 POSTER with stand', price: 230 },
            { name: 'A1 POSTER without stand', price: 180 },
            { name: 'MENU BOOK', price: 85 },
            { name: 'Photography Services', price: 40 },
            { name: 'EASYROLL', price: 280 },
            { name: 'TRANSFORMER replacement', price: 180 },
            { name: 'PRICING STICKER', price: 50 },
            { name: 'T5 LED LIGHT TUBE', price: 25 },
            { name: 'T8 LED LIGHT TUBE', price: 35 },
            { name: 'Photo for food delivery platform', price: 10 },
            { name: 'LIGHTBOX', price: 0 },
            { name: 'LIGHTBOX W BACKLIT', price: 0 },
            { name: 'BACKLIT', price: 0 },
            { name: 'BACKLIT ACRYLIC', price: 0 },
            { name: 'TRANS', price: 0 },
            { name: 'TRANS ACRYLIC', price: 0 },
            { name: 'VINYL ECO', price: 0 },
            { name: 'VINYL STICKER', price: 0 },
            { name: 'VINYL PREMIUM', price: 0 },
            { name: 'ACRYLIC', price: 0 },
            { name: '3D PRINTED SIGN', price: 0 },
            { name: 'LED STRIP LIGHTING', price: 0 },
        ];

        const THEME_STYLES = {
            gold: { border: 'border-yellow-500/40', text: 'text-yellow-800 dark:text-yellow-100', price: 'text-yellow-700 dark:text-yellow-50', bgHover: '', decoration: 'bg-yellow-400', shadowHover: '', modalBg: 'bg-yellow-50/80 dark:bg-yellow-900/50', modalBorder: 'border-yellow-200/50 dark:border-yellow-500/30', dotGlow: '', textGlow: '', inputFocus: 'focus:text-yellow-500 dark:focus:text-yellow-300', cardHoverText: 'group-hover:text-yellow-600 dark:group-hover:text-yellow-300', variantHoverText: 'group-hover/btn:text-yellow-600 dark:group-hover/btn:text-yellow-300' },
            yellow: { border: 'border-yellow-400/40', text: 'text-yellow-900 dark:text-yellow-100', price: 'text-yellow-700 dark:text-yellow-50', bgHover: '', decoration: 'bg-yellow-400', shadowHover: '', modalBg: 'bg-yellow-50/80 dark:bg-yellow-900/50', modalBorder: 'border-yellow-200/50 dark:border-yellow-500/30', dotGlow: '', textGlow: '', inputFocus: 'focus:text-yellow-500 dark:focus:text-yellow-300', cardHoverText: 'group-hover:text-yellow-600 dark:group-hover:text-yellow-300', variantHoverText: 'group-hover/btn:text-yellow-600 dark:group-hover/btn:text-yellow-300' },
            blue: { border: 'border-blue-500/40', text: 'text-blue-800 dark:text-blue-100', price: 'text-blue-700 dark:text-blue-50', bgHover: '', decoration: 'bg-blue-400', shadowHover: '', modalBg: 'bg-blue-50/80 dark:bg-blue-950/60', modalBorder: 'border-blue-200/50 dark:border-blue-500/30', dotGlow: '', textGlow: '', inputFocus: 'focus:text-blue-500 dark:focus:text-blue-300', cardHoverText: 'group-hover:text-blue-600 dark:group-hover:text-blue-300', variantHoverText: 'group-hover/btn:text-blue-600 dark:group-hover/btn:text-blue-300' },
            indigo: { border: 'border-indigo-500/40', text: 'text-indigo-800 dark:text-indigo-100', price: 'text-indigo-700 dark:text-indigo-50', bgHover: '', decoration: 'bg-indigo-500', shadowHover: '', modalBg: 'bg-indigo-50/80 dark:bg-indigo-950/60', modalBorder: 'border-indigo-200/50 dark:border-indigo-500/30', dotGlow: '', textGlow: '', inputFocus: 'focus:text-indigo-600 dark:focus:text-indigo-300', cardHoverText: 'group-hover:text-indigo-600 dark:group-hover:text-indigo-300', variantHoverText: 'group-hover/btn:text-indigo-600 dark:group-hover/btn:text-indigo-300' },
            cyan: { border: 'border-cyan-500/40', text: 'text-cyan-800 dark:text-cyan-100', price: 'text-cyan-700 dark:text-cyan-50', bgHover: '', decoration: 'bg-cyan-400', shadowHover: '', modalBg: 'bg-cyan-50/80 dark:bg-cyan-950/60', modalBorder: 'border-cyan-200/50 dark:border-cyan-500/30', dotGlow: '', textGlow: '', inputFocus: 'focus:text-cyan-500 dark:focus:text-cyan-300', cardHoverText: 'group-hover:text-cyan-600 dark:group-hover:text-cyan-300', variantHoverText: 'group-hover/btn:text-cyan-600 dark:group-hover/btn:text-cyan-300' },
            orange: { border: 'border-orange-500/40', text: 'text-orange-800 dark:text-orange-100', price: 'text-orange-700 dark:text-orange-50', bgHover: '', decoration: 'bg-orange-400', shadowHover: '', modalBg: 'bg-orange-50/80 dark:bg-orange-950/60', modalBorder: 'border-orange-200/50 dark:border-orange-500/30', dotGlow: '', textGlow: '', inputFocus: 'focus:text-orange-500 dark:focus:text-orange-300', cardHoverText: 'group-hover:text-orange-600 dark:group-hover:text-orange-300', variantHoverText: 'group-hover/btn:text-orange-600 dark:group-hover/btn:text-orange-300' },
            gray: { border: 'border-gray-500/40', text: 'text-gray-800 dark:text-gray-100', price: 'text-gray-700 dark:text-white', bgHover: '', decoration: 'bg-gray-300', shadowHover: '', modalBg: 'bg-gray-100/80 dark:bg-gray-900/50', modalBorder: 'border-gray-200/50 dark:border-gray-600/50', dotGlow: '', textGlow: '', inputFocus: 'focus:text-gray-500 dark:focus:text-gray-300', cardHoverText: 'group-hover:text-gray-600 dark:group-hover:text-white', variantHoverText: 'group-hover/btn:text-gray-600 dark:group-hover/btn:text-white' },
            green: { border: 'border-green-500/40', text: 'text-green-800 dark:text-green-100', price: 'text-green-700 dark:text-green-50', bgHover: '', decoration: 'bg-green-400', shadowHover: '', modalBg: 'bg-green-50/80 dark:bg-green-950/60', modalBorder: 'border-green-200/50 dark:border-green-500/30', dotGlow: '', textGlow: '', inputFocus: 'focus:text-green-500 dark:focus:text-green-300', cardHoverText: 'group-hover:text-green-600 dark:group-hover:text-green-300', variantHoverText: 'group-hover/btn:text-green-600 dark:group-hover/btn:text-green-300' },
            purple: { border: 'border-purple-500/40', text: 'text-purple-800 dark:text-purple-100', price: 'text-purple-700 dark:text-purple-50', bgHover: '', decoration: 'bg-purple-400', shadowHover: '', modalBg: 'bg-purple-50/80 dark:bg-purple-950/60', modalBorder: 'border-purple-200/50 dark:border-purple-500/30', dotGlow: '', textGlow: '', inputFocus: 'focus:text-purple-500 dark:focus:text-purple-300', cardHoverText: 'group-hover:text-purple-600 dark:group-hover:text-purple-300', variantHoverText: 'group-hover/btn:text-purple-600 dark:group-hover/btn:text-purple-300' },
            amber: { border: 'border-amber-500/40', text: 'text-amber-800 dark:text-amber-100', price: 'text-amber-700 dark:text-amber-50', bgHover: '', decoration: 'bg-amber-400', shadowHover: '', modalBg: 'bg-amber-50/80 dark:bg-amber-950/60', modalBorder: 'border-amber-200/50 dark:border-amber-500/30', dotGlow: '', textGlow: '', inputFocus: 'focus:text-amber-500 dark:focus:text-amber-300', cardHoverText: 'group-hover:text-amber-600 dark:group-hover:text-amber-300', variantHoverText: 'group-hover/btn:text-amber-600 dark:group-hover/btn:text-amber-300' },
            red: { border: 'border-red-500/40', text: 'text-red-800 dark:text-red-100', price: 'text-red-700 dark:text-red-50', bgHover: '', decoration: 'bg-red-400', shadowHover: '', modalBg: 'bg-red-50/80 dark:bg-red-950/60', modalBorder: 'border-red-200/50 dark:border-red-500/30', dotGlow: '', textGlow: '', inputFocus: 'focus:text-red-500 dark:focus:text-red-300', cardHoverText: 'group-hover:text-red-600 dark:group-hover:text-red-300', variantHoverText: 'group-hover/btn:text-red-600 dark:group-hover/btn:text-red-300' },
            beige: { border: 'border-stone-400/40', text: 'text-stone-800 dark:text-stone-100', price: 'text-stone-700 dark:text-stone-50', bgHover: '', decoration: 'bg-stone-400', shadowHover: '', modalBg: 'bg-stone-100/80 dark:bg-stone-900/50', modalBorder: 'border-stone-200/50 dark:border-stone-500/30', dotGlow: '', textGlow: '', inputFocus: 'focus:text-stone-600 dark:focus:text-stone-300', cardHoverText: 'group-hover:text-stone-600 dark:group-hover:text-stone-300', variantHoverText: 'group-hover/btn:text-stone-600 dark:group-hover/btn:text-stone-300' },
        };

        /* --- UTILS --- */
        const CM_PER_INCH = 2.54;
        const MM_PER_INCH = 25.4;
        const INCHES_PER_FOOT = 12;

        const convertToInches = (value, unit) => {
            switch (unit) {
                case Unit.IN: return value;
                case Unit.FT: return value * INCHES_PER_FOOT;
                case Unit.CM: return value / CM_PER_INCH;
                case Unit.MM: return value / MM_PER_INCH;
                default: return 0;
            }
        };

        const convertFromInches = (valueInches, targetUnit) => {
            switch (targetUnit) {
                case Unit.FT: return valueInches / INCHES_PER_FOOT;
                case Unit.CM: return valueInches * CM_PER_INCH;
                case Unit.MM: return valueInches * MM_PER_INCH;
                case Unit.IN: return valueInches;
                default: return valueInches;
            }
        };

        const calculatePrices = (widthVal, heightVal, unit, customRates = null) => {
            const RATES_USE = customRates || RATES;
            
            if (widthVal <= 0 || heightVal <= 0) {
                return {
                    areaSqFt: 0,
                    prices: { 
                        lightboxBacklit: 0, lightboxOnly: 0, backlitOnly: 0, backlitAcrylic: 0, 
                        transOnly: 0, transAcrylic: 0, vinylEco: 0, vinylStd: 0, vinylPrem: 0, 
                        acrylic: 0, printed3d: 0, ledStrip: 0 
                    },
                    dimensions: { w_in: 0, h_in: 0, w_ft: 0, h_ft: 0, w_cm: 0, h_cm: 0, w_mm: 0, h_mm: 0 }
                };
            }

            const w_in = convertToInches(widthVal, unit);
            const h_in = convertToInches(heightVal, unit);
            
            const w_ft = convertFromInches(w_in, Unit.FT);
            const h_ft = convertFromInches(h_in, Unit.FT);
            
            const w_cm = convertFromInches(w_in, Unit.CM);
            const h_cm = convertFromInches(h_in, Unit.CM);
            
            const w_mm = convertFromInches(w_in, Unit.MM);
            const h_mm = convertFromInches(h_in, Unit.MM);

            const areaSqFt = w_ft * h_ft;
            
            return {
                areaSqFt,
                prices: {
                    lightboxBacklit: areaSqFt * RATES_USE.LIGHTBOX_W_BACKLIT,
                    lightboxOnly: areaSqFt * RATES_USE.LIGHTBOX_ONLY,
                    backlitOnly: areaSqFt * RATES_USE.BACKLIT_ONLY,
                    backlitAcrylic: areaSqFt * RATES_USE.BACKLIT_ACRYLIC,
                    transOnly: areaSqFt * RATES_USE.TRANS_ONLY,
                    transAcrylic: areaSqFt * RATES_USE.TRANS_ACRYLIC,
                    vinylEco: areaSqFt * RATES_USE.VINYL_ECO,
                    vinylStd: areaSqFt * RATES_USE.VINYL_STD,
                    vinylPrem: areaSqFt * RATES_USE.VINYL_PREM,
                    acrylic: areaSqFt * RATES_USE.ACRYLIC,
                    printed3d: areaSqFt * RATES_USE.PRINTED_3D,
                    ledStrip: (w_in / LED_STRIP_DIVISOR_W) * (h_in / LED_STRIP_DIVISOR_H) * LED_STRIP_MULTIPLIER
                },
                dimensions: { w_in, h_in, w_ft, h_ft, w_cm, h_cm, w_mm, h_mm }
            };
        };

        const getDoc = () => {
            try {
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    throw new Error("jsPDF library not loaded");
                }
                const { jsPDF } = window.jspdf;
                return new jsPDF();
            } catch (e) {
                console.error("Failed to initialize jsPDF:", e);
                throw e;
            }
        };

        const drawHeader = (doc, data, type) => {
            const pageWidth = doc.internal.pageSize.width;
            const margin = 14;
            const logoX = margin; 
            const logoY = 15;
            const textRightX = pageWidth - margin - 1.5;

            doc.setTextColor(0, 0, 0); 
            doc.setFont("helvetica", "bold");
            doc.setFontSize(16); 
            doc.text(type, textRightX, logoY + 8, { align: 'right' });

            const addrY = logoY + 15; 
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.setFont("helvetica", "bold");
            const lineHeight = 4.5;
            doc.text("BLK 113 EUNOS AVE 3, #01-16", textRightX, addrY, { align: 'right' });
            doc.text("GORDON INDUSTRIAL BUILDING", textRightX, addrY + lineHeight, { align: 'right' });
            doc.text("SINGAPORE 409838", textRightX, addrY + (lineHeight * 2), { align: 'right' });
            doc.text("Tel: 6844 4928 / 6844 4929", textRightX, addrY + (lineHeight * 3), { align: 'right' });

            if (data.logo) {
                try {
                    doc.addImage(data.logo, 'PNG', logoX, logoY, 44, 25, undefined, 'FAST');
                } catch (e) { console.error("Error adding logo", e); }
            } else {
                const textX = logoX;
                const textY = logoY + 10; 
                doc.setTextColor(0, 0, 0);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(28); 
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.6);
                
                const charSpaceHal = 0.4;
                doc.text("hal", textX, textY, { renderingMode: 'fillThenStroke', charSpace: charSpaceHal });
                const rawHalWidth = doc.getTextWidth("hal");
                const halWidth = rawHalWidth + (2 * charSpaceHal);
                const dhY = textY + 2.2; 
                doc.setFont("helvetica", "normal"); 
                doc.setFontSize(7);
                doc.setTextColor(80, 80, 80); 
                doc.setLineWidth(0.1); 
                doc.text("DESIGN HUB", textX, dhY, { renderingMode: 'fill' });
                
                const iconCx = textX + halWidth + 8; const iconCy = textY - 1; 
                doc.setDrawColor(0, 0, 0); doc.setLineWidth(1.6); doc.circle(iconCx, iconCy, 6.5, 'S');
                doc.setDrawColor(193, 216, 47); doc.setLineWidth(2.5); doc.circle(iconCx, iconCy, 3.5, 'S');
                
                const angle = -45 * (Math.PI / 180);
                doc.setDrawColor(255, 255, 255); doc.setLineWidth(2.2); doc.line(iconCx, iconCy, iconCx + Math.cos(angle) * 4.8, iconCy + Math.sin(angle) * 4.8);
                doc.setDrawColor(0, 0, 0); doc.setLineWidth(1.2); doc.line(iconCx, iconCy, iconCx + Math.cos(angle) * 4.8, iconCy + Math.sin(angle) * 4.8);
                
                doc.setFillColor(255, 255, 255); doc.circle(iconCx - 6.5, iconCy, 1.4, 'F');
                doc.setFillColor(128, 128, 128); doc.circle(iconCx - 6.5, iconCy, 0.9, 'F');
                
                doc.setDrawColor(80, 80, 80); doc.setLineWidth(0.4);
                doc.line(textX, dhY + 1.5, textX + halWidth, dhY + 1.5); 
                doc.setDrawColor(0, 0, 0); doc.setLineWidth(0.2);
            }
        };

        const finalizePDF = (doc, data, type, action) => {
            const pageCount = doc.internal.getNumberOfPages();
            const width = doc.internal.pageSize.width;
            const height = doc.internal.pageSize.height;
            
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                drawHeader(doc, data, type);
                
                doc.setFont("helvetica", "normal");
                doc.setFontSize(8);
                doc.setTextColor(100);
                doc.text(`Page ${i} of ${pageCount}`, width - 14, height - 10, { align: 'right' });
            }

            if (action === 'save') {
                doc.save(`${type.charAt(0) + type.slice(1).toLowerCase()}_${data.docNo || 'Draft'}.pdf`);
            } else {
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobile) {
                    const dataUri = doc.output('datauristring');
                    window.open(dataUri, '_blank');
                } else {
                    window.open(doc.output('bloburl'), '_blank');
                }
            }
        };

        const generateQuotationPDF = (items, data, grandTotal, discountAmount, finalTotal, action) => {
            const doc = getDoc();
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 14;
            const cellPadding = 1.5; 
            const textLeftX = margin + cellPadding;
            const textRightX = pageWidth - margin - cellPadding;

            let currentY = 55;
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("QUOTATION TO:", textLeftX, currentY);
            currentY += 6;
            doc.setFont("helvetica", "normal");
            doc.text((data.customerName || "").toUpperCase(), textLeftX, currentY);
            currentY += 5;
            const addressLines = doc.splitTextToSize((data.customerAddress || "").toUpperCase(), 90);
            doc.text(addressLines, textLeftX, currentY);
            currentY += (addressLines.length * 5);
            if (data.contact) {
                doc.text(`ATTN: ${data.contact.toUpperCase()}`, textLeftX, currentY);
            }

            const startInfoY = 55;
            const labelX = textRightX - 60; 
            doc.setFont("helvetica", "bold");
            doc.text("QUOTATION NO:", labelX, startInfoY);
            doc.setTextColor(220, 38, 38);
            doc.text(data.docNo || "DRAFT", textRightX, startInfoY, { align: 'right' });
            doc.setTextColor(0, 0, 0);
            doc.text("DATE:", labelX, startInfoY + 6);
            doc.setFont("helvetica", "normal");
            const dateStr = new Date().toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' });
            doc.text(dateStr, textRightX, startInfoY + 6, { align: 'right' });

            const subjectY = Math.max(currentY + 15, startInfoY + 25);
            doc.setFont("helvetica", "bold");
            doc.text("RE: TO DESIGN, SUPPLY & INSTALL", textLeftX, subjectY);

            const tableBody = items.map((item, index) => {
                const noStr = (index + 1).toString() + ".";
                let desc = item.title.toUpperCase();
                if (data.showSizes && item.originalWidth > 0) desc += `    [${item.originalWidth}X${item.originalHeight} ${(item.unit || '').toUpperCase()}]`;
                let qtyStr = `x${item.quantity}`;
                let priceStr = item.totalPrice === 0 ? "FOC" : `$${(item.totalPrice * item.quantity).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                return [noStr, desc, qtyStr, priceStr];
            });

            doc.autoTable({
                body: tableBody,
                startY: subjectY + 5,
                theme: 'plain',
                styles: { font: 'helvetica', fontSize: 10, cellPadding: cellPadding, textColor: [0, 0, 0], },
                columnStyles: { 
                    0: { cellWidth: 8, halign: 'left', fontStyle: 'normal' },
                    1: { cellWidth: 'auto', fontStyle: 'normal' }, 
                    2: { cellWidth: 15, halign: 'right', fontStyle: 'normal' }, 
                    3: { cellWidth: 40, halign: 'right', fontStyle: 'bold' }, 
                },
                margin: { top: 55, right: margin, left: margin }, 
                didParseCell: (data) => {
                    if (data.column.index === 3 && data.cell.raw === "FOC") data.cell.styles.textColor = [220, 38, 38];
                }
            });

            const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY : subjectY + 20;
            const tableEndY = finalY + 10;
            if (tableEndY + 50 > pageHeight) doc.addPage();
            const sectionY = tableEndY > pageHeight - 50 ? 55 : tableEndY; 

            let totalsY = sectionY + 10; 
            const totalsLabelX = textRightX - 60; 
            doc.setFontSize(10);
            if (discountAmount > 0) {
                doc.setFont("helvetica", "normal");
                doc.text("Subtotal", totalsLabelX, totalsY);
                doc.text(`$${grandTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, textRightX, totalsY, { align: 'right' });
                totalsY += 6;
                doc.setTextColor(220, 38, 38);
                doc.text("Discount", totalsLabelX, totalsY);
                doc.text(`-$${discountAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, textRightX, totalsY, { align: 'right' });
                doc.setTextColor(0);
                totalsY += 6;
            }

            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text("TOTAL", totalsLabelX, totalsY + 4);
            doc.text(`$${finalTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, textRightX, totalsY + 4, { align: 'right' });
            
            // Display deposit section if deposit exists
            if (data.deposit && data.deposit > 0) {
                doc.setLineWidth(0.2);
                doc.line(totalsLabelX, totalsY - 2, textRightX, totalsY - 2);
                totalsY += 10;
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.text("Deposit", totalsLabelX, totalsY);
                if (data.paymentMethod) {
                    const depositWidth = doc.getTextWidth("Deposit");
                    doc.setFontSize(7);
                    doc.text(`(${data.paymentMethod})`, totalsLabelX + depositWidth + 1.5, totalsY);
                    doc.setFontSize(10);
                }
                doc.text(`-$${data.deposit.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, textRightX, totalsY, { align: 'right' });
                totalsY += 6;
                
                const balanceDue = Math.max(0, finalTotal - data.deposit);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.text("BALANCE", totalsLabelX, totalsY + 4);
                doc.text(`$${balanceDue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, textRightX, totalsY + 4, { align: 'right' });
                totalsY += 6;
            }
            
            // Show PAID section if depositPaid is true (regardless of deposit amount)
            if (data.depositPaid) {
                if (!data.deposit || data.deposit === 0) {
                    doc.setLineWidth(0.2);
                    doc.line(totalsLabelX, totalsY - 2, textRightX, totalsY - 2);
                    totalsY += 10;
                }
                
                // Draw PAID Stamp
                const stampX = (totalsLabelX + textRightX) / 2;
                const stampY = totalsY + 15;
                
                doc.setTextColor(220, 38, 38);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                
                // Save current state
                doc.saveGraphicsState();
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(0.8);
                
                // Draw border rectangle around PAID by payment method and date
                const boxWidth = 70;
                const boxHeight = data.depositPaidDate ? 28 : 18;
                doc.rect(stampX - boxWidth/2, stampY - boxHeight/2, boxWidth, boxHeight);
                
                // Restore and draw text
                doc.restoreGraphicsState();
                const paidText = data.paymentMethod ? `PAID by ${data.paymentMethod}` : "PAID";
                doc.text(paidText, stampX, stampY - 4, { align: 'center' });
                
                if (data.depositPaidDate) {
                    doc.setTextColor(220, 38, 38);
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(10);
                    doc.text(data.depositPaidDate, stampX, stampY + 7, { align: 'center' });
                }
                
                totalsY += 35;
                doc.setTextColor(0, 0, 0);
            }
            
            if (data.deposit && data.deposit > 0) {
                doc.setLineWidth(0.5);
                doc.line(totalsLabelX, totalsY + 2, textRightX, totalsY + 2);
                doc.setLineWidth(0.2);
                doc.line(totalsLabelX, totalsY + 3, textRightX, totalsY + 3);
            } else if (data.depositPaid) {
                doc.setLineWidth(0.5);
                doc.line(totalsLabelX, totalsY + 2, textRightX, totalsY + 2);
                doc.setLineWidth(0.2);
                doc.line(totalsLabelX, totalsY + 3, textRightX, totalsY + 3);
            } else {
                doc.setLineWidth(0.2);
                doc.line(totalsLabelX, totalsY - 2, textRightX, totalsY - 2);
                doc.setLineWidth(0.5);
                doc.line(totalsLabelX, totalsY + 6, textRightX, totalsY + 6);
                doc.setLineWidth(0.2);
                doc.line(totalsLabelX, totalsY + 7, textRightX, totalsY + 7);
            }

            let termsY = Math.max(sectionY + 20, totalsY + 20);
            if (termsY + 70 > pageHeight) { doc.addPage(); termsY = 55; }

            doc.setFont("helvetica", "bold");
            doc.setFontSize(9);
            doc.text("TERMS & CONDITIONS", margin, termsY);
            termsY += 6;
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(8);
            
            const terms = [
                "*Mode of Payment: 50% deposit upon signing of this quotation, 50% upon job completion.",
                "*Validity of Quotation: 30 days from the stated date.",
                "*Variation Orders: Any items not included or quoted in the original document shall be considered a variation order.",
                "*Return Policy: Goods sold are not returnable or exchangeable.",
                "*Exclusions: This quotation does not include professional handling charges payable to PUB, URA, or other costs required by any authorized body or management, unless explicitly stipulated.",
                "*Payment Methods:",
                "PayNow 96964883 (CHEN LI SHAN)",
                "Bank Transfer (UOB) 310-384-765-4",
                "*Warranty: T5 and LED lights are guaranteed and warranted for 2 months only."
            ];

            terms.forEach(term => {
                if (term.includes("Payment Methods:") || term.includes("PayNow") || term.includes("Bank Transfer")) doc.setFont("helvetica", "bold");
                else doc.setFont("helvetica", "normal");
                const splitTerm = doc.splitTextToSize(term, pageWidth - (margin * 2));
                if (termsY + (splitTerm.length * 4) > pageHeight - 20) {
                    doc.addPage();
                    termsY = 55;
                }
                doc.text(splitTerm, margin, termsY);
                termsY += (splitTerm.length * 4) + 1;
            });

            finalizePDF(doc, data, 'QUOTATION', action);
        };

        const generateReceiptPDF = (items, data, grandTotal, discountAmount, finalTotal, action) => {
            const doc = getDoc();
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 14;
            const cellPadding = 1.5; 
            const textLeftX = margin + cellPadding;
            const textRightX = pageWidth - margin - cellPadding;

            let currentY = 55;
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("RECEIVED FROM:", textLeftX, currentY);
            currentY += 6;
            doc.setFont("helvetica", "normal");
            doc.text((data.customerName || "").toUpperCase(), textLeftX, currentY);
            currentY += 5;
            const addressLines = doc.splitTextToSize((data.customerAddress || "").toUpperCase(), 90);
            doc.text(addressLines, textLeftX, currentY);
            currentY += (addressLines.length * 5);
            if (data.contact) doc.text(`ATTN: ${data.contact.toUpperCase()}`, textLeftX, currentY);

            const startInfoY = 55;
            const labelX = textRightX - 40;
            doc.setFont("helvetica", "bold");
            doc.text("RECEIPT NO:", labelX, startInfoY);
            doc.setTextColor(220, 38, 38);
            doc.text(data.docNo || "84224", textRightX, startInfoY, { align: 'right' });
            doc.setTextColor(0, 0, 0);
            doc.text("DATE:", labelX, startInfoY + 6);
            doc.setFont("helvetica", "normal");
            const dateStr = new Date().toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' });
            doc.text(dateStr, textRightX, startInfoY + 6, { align: 'right' });

            const subjectY = Math.max(currentY + 15, startInfoY + 25);
            doc.setFont("helvetica", "bold");
            doc.text("RE: TO DESIGN, SUPPLY & INSTALL", textLeftX, subjectY);

            const tableBody = items.map((item, index) => {
                const noStr = (index + 1).toString() + ".";
                let desc = item.title.toUpperCase();
                if (data.showSizes && item.originalWidth > 0) desc += `    [${item.originalWidth}X${item.originalHeight} ${(item.unit || '').toUpperCase()}]`;
                let qtyStr = `x${item.quantity}`;
                let priceStr = item.totalPrice === 0 ? "FOC" : `$${(item.totalPrice * item.quantity).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                return [noStr, desc, qtyStr, priceStr];
            });

            doc.autoTable({
                body: tableBody,
                startY: subjectY + 5,
                theme: 'plain',
                styles: { font: 'helvetica', fontSize: 10, cellPadding: cellPadding, textColor: [0, 0, 0], },
                columnStyles: { 
                    0: { cellWidth: 8, halign: 'left', fontStyle: 'normal' },
                    1: { cellWidth: 'auto', fontStyle: 'normal' }, 
                    2: { cellWidth: 15, halign: 'right', fontStyle: 'normal' }, 
                    3: { cellWidth: 40, halign: 'right', fontStyle: 'bold' }, 
                },
                margin: { top: 55, right: margin, left: margin },
                didParseCell: (data) => {
                    if (data.column.index === 3 && data.cell.raw === "FOC") data.cell.styles.textColor = [220, 38, 38];
                }
            });

            const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY : subjectY + 20;
            const tableEndY = finalY + 10;
            if (tableEndY + 50 > pageHeight) doc.addPage();
            const sectionY = tableEndY > pageHeight - 50 ? 55 : tableEndY;

            const boxWidth = 100;
            const boxHeight = 35;
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.1);
            doc.roundedRect(margin, sectionY, boxWidth, boxHeight, 3, 3);
            
            const boxPad = 5;
            let boxY = sectionY + boxPad + 4;
            const paymentValueX = margin + boxPad + 45; 
            
            doc.setFontSize(9);
            doc.setFont("helvetica", "bold");
            doc.text("PAYMENT DETAILS", margin + boxPad, boxY);
            boxY += 6;
            doc.setFont("helvetica", "normal");
            doc.text("PayNow", margin + boxPad, boxY);
            doc.setFont("helvetica", "bold");
            doc.text("96964883 (CHEN LI SHAN)", paymentValueX, boxY);
            boxY += 5;
            doc.setFont("helvetica", "normal");
            doc.text("Bank Transfer (UOB)", margin + boxPad, boxY);
            doc.setFont("helvetica", "bold");
            doc.text("310-384-765-4", paymentValueX, boxY);
            boxY += 10;
            doc.setFont("helvetica", "italic");
            doc.setFontSize(7);
            doc.setTextColor(100);
            doc.text("*Please indicate receipt number as reference.", margin + boxPad, boxY);
            doc.setTextColor(0);

            let totalsY = sectionY + 10; 
            const totalsLabelX = textRightX - 60; 
            
            doc.setFontSize(10);
            if (discountAmount > 0) {
                doc.setFont("helvetica", "normal");
                doc.text("Subtotal", totalsLabelX, totalsY);
                doc.text(`$${grandTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, textRightX, totalsY, { align: 'right' });
                totalsY += 6;
                doc.setTextColor(220, 38, 38);
                doc.text("Discount", totalsLabelX, totalsY);
                doc.text(`-$${discountAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, textRightX, totalsY, { align: 'right' });
                doc.setTextColor(0);
                totalsY += 6;
            }

            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text("TOTAL", totalsLabelX, totalsY + 4);
            doc.text(`$${finalTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, textRightX, totalsY + 4, { align: 'right' });
            
            if (data.deposit && data.deposit > 0) {
                doc.setLineWidth(0.2);
                doc.line(totalsLabelX, totalsY - 2, textRightX, totalsY - 2);
                totalsY += 10; 
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.text("Deposit", totalsLabelX, totalsY);
                if (data.paymentMethod) {
                    const depositWidth = doc.getTextWidth("Deposit");
                    doc.setFontSize(7);
                    doc.text(`(${data.paymentMethod})`, totalsLabelX + depositWidth + 1.5, totalsY);
                    doc.setFontSize(10);
                }
                doc.text(`-$${data.deposit.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, textRightX, totalsY, { align: 'right' });
                totalsY += 6;
                
                const balanceDue = Math.max(0, finalTotal - data.deposit);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.text("BALANCE", totalsLabelX, totalsY + 4);
                doc.text(`$${balanceDue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, textRightX, totalsY + 4, { align: 'right' });
                totalsY += 10;
            }
            
            // Show PAID section if depositPaid is true (regardless of deposit amount)
            if (data.depositPaid) {
                if (!data.deposit || data.deposit === 0) {
                    doc.setLineWidth(0.2);
                    doc.line(totalsLabelX, totalsY - 2, textRightX, totalsY - 2);
                    totalsY += 10;
                } else {
                    totalsY += 4;
                }
                
                // Draw PAID Stamp
                const stampX = (totalsLabelX + textRightX) / 2;
                const stampY = totalsY + 15;
                
                doc.setTextColor(220, 38, 38);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                
                // Save current state
                doc.saveGraphicsState();
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(0.8);
                
                // Draw border rectangle around PAID by payment method and date
                const boxWidth = 70;
                const boxHeight = data.depositPaidDate ? 28 : 18;
                doc.rect(stampX - boxWidth/2, stampY - boxHeight/2, boxWidth, boxHeight);
                
                // Restore and draw text
                doc.restoreGraphicsState();
                const paidText = data.paymentMethod ? `PAID by ${data.paymentMethod}` : "PAID";
                doc.text(paidText, stampX, stampY - 4, { align: 'center' });
                
                if (data.depositPaidDate) {
                    doc.setTextColor(220, 38, 38);
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(10);
                    doc.text(data.depositPaidDate, stampX, stampY + 7, { align: 'center' });
                }
                
                totalsY += 35;
                doc.setTextColor(0, 0, 0);
            }
            
            if (data.deposit && data.deposit > 0) {
                doc.setLineWidth(0.5);
                doc.line(totalsLabelX, totalsY + 2, textRightX, totalsY + 2);
                doc.setLineWidth(0.2);
                doc.line(totalsLabelX, totalsY + 3, textRightX, totalsY + 3);
            } else if (data.depositPaid) {
                doc.setLineWidth(0.5);
                doc.line(totalsLabelX, totalsY + 2, textRightX, totalsY + 2);
                doc.setLineWidth(0.2);
                doc.line(totalsLabelX, totalsY + 3, textRightX, totalsY + 3);
            } else {
                doc.setLineWidth(0.2);
                doc.line(totalsLabelX, totalsY - 2, textRightX, totalsY - 2);
                doc.setLineWidth(0.5);
                doc.line(totalsLabelX, totalsY + 6, textRightX, totalsY + 6);
                doc.setLineWidth(0.2);
                doc.line(totalsLabelX, totalsY + 7, textRightX, totalsY + 7);
            }

            let termsY = Math.max(sectionY + boxHeight + 10, totalsY + 20);
            if (termsY + 30 > pageHeight) { doc.addPage(); termsY = 55; }

            doc.setFont("helvetica", "bold");
            doc.setFontSize(8);
            doc.text("TERMS & CONDITIONS", margin, termsY);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(7);
            termsY += 4;
            doc.text("1. Goods sold are not returnable or exchangeable.", margin, termsY);
            termsY += 3.5;
            doc.text("2. All T5 lights, LED lights, and power supply drivers carry a 2-month warranty only.", margin, termsY);
            
            finalizePDF(doc, data, 'RECEIPT', action);
        };

        const generateInvoicePDF = (items, data, grandTotal, discountAmount, finalTotal, action) => {
            const doc = getDoc();
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 14;
            const cellPadding = 1.5; 
            const textLeftX = margin + cellPadding;
            const textRightX = pageWidth - margin - cellPadding;

            let currentY = 55;
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("BILL TO:", textLeftX, currentY);
            currentY += 6;
            doc.setFont("helvetica", "normal");
            doc.text((data.customerName || "").toUpperCase(), textLeftX, currentY);
            currentY += 5;
            const addressLines = doc.splitTextToSize((data.customerAddress || "").toUpperCase(), 90);
            doc.text(addressLines, textLeftX, currentY);
            currentY += (addressLines.length * 5);
            if (data.contact) doc.text(`ATTN: ${data.contact.toUpperCase()}`, textLeftX, currentY);

            const startInfoY = 55;
            const labelX = textRightX - 40;
            doc.setFont("helvetica", "bold");
            doc.text("INVOICE NO:", labelX, startInfoY);
            doc.setTextColor(220, 38, 38);
            doc.text(data.docNo || "84224", textRightX, startInfoY, { align: 'right' });
            doc.setTextColor(0, 0, 0);
            doc.text("DATE:", labelX, startInfoY + 6);
            doc.setFont("helvetica", "normal");
            const dateStr = new Date().toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' });
            doc.text(dateStr, textRightX, startInfoY + 6, { align: 'right' });

            const subjectY = Math.max(currentY + 15, startInfoY + 25);
            doc.setFont("helvetica", "bold");
            doc.text("RE: TO DESIGN, SUPPLY & INSTALL", textLeftX, subjectY);

            const tableBody = items.map((item, index) => {
                const noStr = (index + 1).toString() + ".";
                let desc = item.title.toUpperCase();
                if (data.showSizes && item.originalWidth > 0) desc += `    [${item.originalWidth}X${item.originalHeight} ${(item.unit || '').toUpperCase()}]`;
                let qtyStr = `x${item.quantity}`;
                let priceStr = item.totalPrice === 0 ? "FOC" : `$${(item.totalPrice * item.quantity).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                return [noStr, desc, qtyStr, priceStr];
            });

            doc.autoTable({
                body: tableBody,
                startY: subjectY + 5,
                theme: 'plain',
                styles: { font: 'helvetica', fontSize: 10, cellPadding: cellPadding, textColor: [0, 0, 0], },
                columnStyles: { 
                    0: { cellWidth: 8, halign: 'left', fontStyle: 'normal' },
                    1: { cellWidth: 'auto', fontStyle: 'normal' }, 
                    2: { cellWidth: 15, halign: 'right', fontStyle: 'normal' }, 
                    3: { cellWidth: 40, halign: 'right', fontStyle: 'bold' }, 
                },
                margin: { top: 55, right: margin, left: margin },
                didParseCell: (data) => {
                    if (data.column.index === 3 && data.cell.raw === "FOC") data.cell.styles.textColor = [220, 38, 38];
                }
            });

            const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY : subjectY + 20;
            const tableEndY = finalY + 10;
            if (tableEndY + 50 > pageHeight) doc.addPage();
            const sectionY = tableEndY > pageHeight - 50 ? 55 : tableEndY;

            let totalsY = sectionY; 
            const totalsLabelX = textRightX - 60; 
            
            doc.setFontSize(10);
            if (discountAmount > 0) {
                doc.setFont("helvetica", "normal");
                doc.text("Subtotal", totalsLabelX, totalsY);
                doc.text(`$${grandTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, textRightX, totalsY, { align: 'right' });
                totalsY += 6;
                doc.setTextColor(220, 38, 38);
                doc.text("Discount", totalsLabelX, totalsY);
                doc.text(`-$${discountAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, textRightX, totalsY, { align: 'right' });
                doc.setTextColor(0);
                totalsY += 6;
            }

            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text("TOTAL", totalsLabelX, totalsY + 4);
            doc.text(`$${finalTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, textRightX, totalsY + 4, { align: 'right' });
            
            if (data.deposit && data.deposit > 0) {
                doc.setLineWidth(0.2);
                doc.line(totalsLabelX, totalsY - 2, textRightX, totalsY - 2);
                totalsY += 10; 
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.text("Deposit", totalsLabelX, totalsY);
                if (data.paymentMethod) {
                    const depositWidth = doc.getTextWidth("Deposit");
                    doc.setFontSize(7);
                    doc.text(`(${data.paymentMethod})`, totalsLabelX + depositWidth + 1.5, totalsY);
                    doc.setFontSize(10);
                }
                doc.text(`-$${data.deposit.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, textRightX, totalsY, { align: 'right' });
                totalsY += 6;
                
                const balanceDue = Math.max(0, finalTotal - data.deposit);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.text("BALANCE", totalsLabelX, totalsY + 4);
                doc.text(`$${balanceDue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, textRightX, totalsY + 4, { align: 'right' });
                totalsY += 10;
            }
            
            if (data.depositPaid) {
                if (!data.deposit || data.deposit === 0) {
                    doc.setLineWidth(0.2);
                    doc.line(totalsLabelX, totalsY - 2, textRightX, totalsY - 2);
                    totalsY += 10;
                } else {
                    totalsY += 4;
                }
                
                // Draw PAID Stamp
                const stampX = (totalsLabelX + textRightX) / 2;
                const stampY = totalsY + 15;
                
                doc.setTextColor(220, 38, 38);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                
                // Save current state
                doc.saveGraphicsState();
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(0.8);
                
                // Draw border rectangle around PAID by payment method and date
                const boxWidth = 70;
                const boxHeight = data.depositPaidDate ? 28 : 18;
                doc.rect(stampX - boxWidth/2, stampY - boxHeight/2, boxWidth, boxHeight);
                
                // Restore and draw text
                doc.restoreGraphicsState();
                const paidText = data.paymentMethod ? `PAID by ${data.paymentMethod}` : "PAID";
                doc.text(paidText, stampX, stampY - 4, { align: 'center' });
                
                if (data.depositPaidDate) {
                    doc.setTextColor(220, 38, 38);
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(10);
                    doc.text(data.depositPaidDate, stampX, stampY + 7, { align: 'center' });
                }
                
                totalsY += 35;
                doc.setTextColor(0, 0, 0);
            }
            
            if (data.deposit && data.deposit > 0) {
                doc.setLineWidth(0.5); 
                doc.line(totalsLabelX, totalsY + 2, textRightX, totalsY + 2);
                doc.setLineWidth(0.2);
                doc.line(totalsLabelX, totalsY + 3, textRightX, totalsY + 3);
            } else if (data.depositPaid) {
                doc.setLineWidth(0.5);
                doc.line(totalsLabelX, totalsY + 2, textRightX, totalsY + 2);
                doc.setLineWidth(0.2);
                doc.line(totalsLabelX, totalsY + 3, textRightX, totalsY + 3);
            } else {
                doc.setLineWidth(0.2);
                doc.line(totalsLabelX, totalsY - 2, textRightX, totalsY - 2);
                doc.setLineWidth(0.5); 
                doc.line(totalsLabelX, totalsY + 6, textRightX, totalsY + 6);
                doc.setLineWidth(0.2);
                doc.line(totalsLabelX, totalsY + 7, textRightX, totalsY + 7);
            }

            let termsY = Math.max(sectionY, totalsY + 20);
            if (termsY + 30 > pageHeight) { doc.addPage(); termsY = 55; }

            doc.setFont("helvetica", "bold");
            doc.setFontSize(9);
            doc.text("TERMS & CONDITIONS", margin, termsY);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(7.5);
            termsY += 5;
            doc.text("* All Cheques Should be Crossed and made payable to:", margin, termsY);
            doc.setFont("helvetica", "bold");
            termsY += 3.5;
            doc.text("HALO DESIGN HUB", margin, termsY);
            doc.setFont("helvetica", "normal");
            termsY += 3.5;
            doc.text("* Or bank transfer to:", margin, termsY);
            doc.setFont("helvetica", "bold");
            termsY += 3.5;
            doc.text("Halo Design Hub 017-902408-0 DBS Current Acc", margin, termsY);
            doc.setFont("helvetica", "normal");
            termsY += 3.5;
            doc.text("* Or paynow to:", margin, termsY);
            doc.setFont("helvetica", "bold");
            termsY += 3.5;
            doc.text("Halo Design Hub UEN: 53142015M", margin, termsY);
            doc.setFont("helvetica", "normal");
            termsY += 3.5;
            doc.text("* Good Sold are not returnable or exchangeable", margin, termsY);
            termsY += 3.5;
            doc.text("* All T5 Light, LED Light & Power Supply Driver 2 months warranty only", margin, termsY);
            
            finalizePDF(doc, data, 'INVOICE', action);
        };
        const Icon = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Moon = (props) => <Icon {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></Icon>;
        const Sun = (props) => <Icon {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 22v2"/><path d="m19.07 4.93-1.41 1.41"/><path d="m6.34 17.66-1.41 1.41"/><path d="M22 12h-2"/><path d="M2 12h2"/><path d="m19.07 19.07-1.41-1.41"/><path d="m6.34 6.34-1.41 1.41"/></Icon>;
        const Check = (props) => <Icon {...props}><polyline points="20 6 9 17 4 12"/></Icon>;
        const Copy = (props) => <Icon {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></Icon>;
        const Plus = (props) => <Icon {...props}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const X = (props) => <Icon {...props}><path d="M18 6 6 18"/><path d="M6 6l12 12"/></Icon>;
        const ChevronDown = (props) => <Icon {...props}><path d="m6 9 6 6 6-6"/></Icon>;
        const ChevronLeft = (props) => <Icon {...props}><path d="m15 18-6-6 6-6"/></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>;
        const FileText = (props) => <Icon {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></Icon>;
        const Share2 = (props) => <Icon {...props}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></Icon>;
        const Trash = (props) => <Icon {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></Icon>;
        const List = (props) => <Icon {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></Icon>;
        const Ghost = (props) => <Icon {...props}><path d="M9 10h.01"/><path d="M15 10h.01"/><path d="M12 2a8 8 0 0 0-8 8v12l3-3 2.5 2.5L12 19l2.5 2.5L17 19l3 3V10a8 8 0 0 0-8-8z"/></Icon>;
        const Zap = (props) => <Icon {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></Icon>;
        const BoxIcon = (props) => <Icon {...props}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></Icon>;
        const Layers = (props) => <Icon {...props}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></Icon>;
        const Image = (props) => <Icon {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></Icon>;
        const Printer = (props) => <Icon {...props}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></Icon>;
        const Scissors = (props) => <Icon {...props}><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></Icon>;
        const Lightbulb = (props) => <Icon {...props}><circle cx="12" cy="8" r="6" fill="none" strokeWidth="2"/><path d="M9 14h6v2H9z" strokeWidth="2"/><line x1="8" y1="17" x2="16" y2="17" strokeWidth="2"/><line x1="9" y1="19" x2="15" y2="19" strokeWidth="2"/><line x1="10" y1="21" x2="14" y2="21" strokeWidth="2"/></Icon>;
        const CalculatorIconComponent = (props) => <Icon {...props}><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="8" x2="16" y1="10" y2="10"/><line x1="8" x2="12" y1="14" y2="14"/><line x1="8" x2="12" y1="18" y2="18"/><line x1="16" x2="16" y1="14" y2="22"/></Icon>;
        const Eye = (props) => <Icon {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const GripVertical = (props) => <Icon {...props}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></Icon>;

        const getIconForTitle = (title) => {
            const t = title.toUpperCase();
            if (t.includes('LIGHTBOX')) return BoxIcon;
            if (t.includes('BACKLIT')) return Zap;
            if (t.includes('LED')) return Lightbulb;
            if (t.includes('3D')) return Printer;
            if (t.includes('VINYL')) return Scissors;
            if (t.includes('ACRYLIC')) return Layers;
            if (t.includes('TRANS')) return Image;
            return FileText;
        };

        /* --- COMPONENTS --- */
        const Logo = ({ compact = false }) => {
            const isMobile = typeof window !== 'undefined' && window.innerWidth < 768;
            return (
                <div className={`flex flex-col items-start select-none ${compact ? 'scale-75 origin-left' : ''}`}>
                    <div className="flex items-end leading-none filter drop-shadow-md">
                        <span className={`text-gray-800 dark:text-white font-black tracking-tighter leading-none font-mono ${compact ? 'text-2xl sm:text-4xl' : 'text-4xl sm:text-5xl'} text-3d`}>hal</span>
                        <div className="flex items-center justify-center -ml-0.5 -mt-1 relative group">
                            <div className={`${compact ? "w-[24px] h-[24px] sm:w-[32px] sm:h-[32px]" : "w-[36px] h-[36px] sm:h-[48px]" } relative flex items-center justify-center`}>
                                <svg width="100%" height="100%" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg" className="drop-shadow-lg">
                                    <circle cx="30" cy="30" r="28" className={`stroke-gray-700 dark:stroke-white/90 origin-center ${!isMobile ? 'animate-spin-slow' : ''}`} strokeWidth="4" fill="none" strokeDasharray="12 6" strokeLinecap="round"/>
                                    <circle cx="30" cy="30" r="15" stroke="#C1D82F" strokeWidth="10" fill="none" className={`origin-center ${!isMobile ? 'animate-breathe' : ''}`} />
                                    <circle cx="30" cy="30" r="5" stroke="#1f2937" strokeWidth="3" fill="none" className="dark:stroke-white/80" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    {!compact && (
                        <div className="text-gray-500/80 dark:text-white/60 text-[10px] sm:text-xs font-semibold tracking-widest mt-0.5 font-mono drop-shadow-sm">DESIGN HUB</div>
                    )}
                </div>
            );
        };

        const BackgroundEffects = () => {
            const isMobile = typeof window !== 'undefined' && window.innerWidth < 768;
            return (
                <div className="fixed inset-0 w-full h-full overflow-hidden pointer-events-none z-0">
                    <div className="absolute inset-0 z-[1] bg-noise opacity-[0.05]"></div>
                    <div className="absolute inset-0 z-0 dark:opacity-0">
                        {!isMobile && <div className="absolute top-[-20%] left-[-10%] w-[80vw] h-[80vw] bg-rose-300/40 rounded-full blur-[100px] mix-blend-multiply animate-blob"></div>}
                        {!isMobile && <div className="absolute top-[0%] right-[-20%] w-[70vw] h-[70vw] bg-cyan-300/40 rounded-full blur-[100px] mix-blend-multiply animate-blob animation-delay-2000"></div>}
                        {!isMobile && <div className="absolute bottom-[-20%] left-[10%] w-[70vw] h-[70vw] bg-amber-200/40 rounded-full blur-[100px] mix-blend-multiply animate-blob animation-delay-4000"></div>}
                        {isMobile && <div className="absolute inset-0 bg-gradient-to-br from-rose-200 via-cyan-100 to-amber-100 opacity-20"></div>}
                    </div>
                    <div className="absolute inset-0 z-0 opacity-0 dark:opacity-100">
                        <div className="absolute inset-0 bg-gradient-to-b from-neutral-950 via-[#1c1c1e] to-neutral-950"></div>
                        {!isMobile && <div className="absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-white/5 rounded-full blur-[120px] mix-blend-screen animate-blob"></div>}
                        {!isMobile && <div className="absolute bottom-[-10%] left-[20%] w-[600px] h-[600px] bg-gray-500/5 rounded-full blur-[120px] mix-blend-screen animate-blob animation-delay-4000"></div>}
                    </div>
                </div>
            );
        };

        const TouchRipple = () => {
            const [ripples, setRipples] = useState([]);
            useEffect(() => {
                const handler = (e) => {
                    const id = Date.now();
                    setRipples((p) => [...p, { id, x: e.clientX, y: e.clientY }]);
                    setTimeout(() => setRipples((p) => p.filter((r) => r.id !== id)), 800);
                };
                window.addEventListener('pointerdown', handler);
                return () => window.removeEventListener('pointerdown', handler);
            }, []);
            return (
                <div className="fixed inset-0 pointer-events-none z-[100] overflow-hidden">
                    {ripples.map((r) => (
                        <div key={r.id} className="absolute top-0 left-0" style={{ transform: `translate(${r.x}px, ${r.y}px)` }}>
                            <div className="absolute -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-[#C1D82F] rounded-full animate-[ping_0.6s_cubic-bezier(0,0,0.2,1)_1] opacity-90"></div>
                            <div className="absolute -translate-x-1/2 -translate-y-1/2 w-8 h-8 border-[2px] border-[#C1D82F] rounded-full animate-ripple opacity-80 shadow-[0_0_15px_rgba(193,216,47,0.6)]"></div>
                            <div className="absolute -translate-x-1/2 -translate-y-1/2 w-8 h-8 border border-white/80 rounded-full animate-[ripple_0.8s_cubic-bezier(0,0,0.2,1)_forwards] opacity-50 delay-75"></div>
                        </div>
                    ))}
                </div>
            );
        };

        const PricingCard = ({ 
            title, rateDescription, price, colorTheme, 
            isReordering, isDragging, onInteraction, 
            ...props 
        }) => {
            const styles = THEME_STYLES[colorTheme] || THEME_STYLES.gray;
            const [isVisible, setIsVisible] = useState(false);
            const [isClicked, setIsClicked] = useState(false);
            const ref = useRef(null);
            const IconComponent = getIconForTitle(title);

            const longPressTimerRef = useRef(null);
            const isLongPressRef = useRef(false);

            useEffect(() => {
                const observer = new IntersectionObserver(([entry]) => {
                    if (entry.isIntersecting) {
                        setIsVisible(true);
                        observer.disconnect();
                    }
                }, { threshold: 0.1 });

                if (ref.current) observer.observe(ref.current);
                return () => observer.disconnect();
            }, []);

            const handlePointerDown = useCallback((e) => {
                if (e.button !== 0) return; 
                
                isLongPressRef.current = false;
                longPressTimerRef.current = setTimeout(() => {
                    isLongPressRef.current = true;
                    if (navigator.vibrate) navigator.vibrate(50);
                    onInteraction('longpress');
                }, 500);
            }, [onInteraction]);

            const handlePointerUp = useCallback(() => {
                if (longPressTimerRef.current) {
                    clearTimeout(longPressTimerRef.current);
                    longPressTimerRef.current = null;
                }
            }, []);

            const handlePointerLeave = useCallback(() => {
                if (longPressTimerRef.current) {
                    clearTimeout(longPressTimerRef.current);
                    longPressTimerRef.current = null;
                }
            }, []);

            const handleClick = useCallback((e) => {
                if (isReordering) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                if (isLongPressRef.current) {
                    isLongPressRef.current = false;
                    return;
                }

                setIsClicked(true);
                setTimeout(() => setIsClicked(false), 200);
                onInteraction('click');
            }, [isReordering, onInteraction]);

            return (
                <div 
                    ref={ref}
                    onPointerDown={handlePointerDown}
                    onPointerUp={handlePointerUp}
                    onPointerLeave={handlePointerLeave}
                    onClick={handleClick}
                    onContextMenu={(e) => e.preventDefault()}
                    className={`group relative w-full h-full min-h-[80px] sm:min-h-[100px] outline-none touch-manipulation perspective-1000 transition-all duration-300 ease-out select-none cursor-pointer 
                        ${isVisible ? 'opacity-100 translate-y-0 scale-100' : 'opacity-0 translate-y-8 scale-95'} 
                        ${isReordering ? 'animate-shake z-20 cursor-move' : ''}
                        ${isDragging ? 'opacity-30 scale-90' : ''}`}
                    {...props}
                >
                    <div className={`relative w-full h-full p-3 sm:p-4 rounded-xl flex flex-col justify-between items-start transition-all duration-200 bg-white/20 dark:bg-[#121212]/80 backdrop-blur-xl saturate-150 border border-white/40 dark:border-white/10 shadow-[0_8px_32px_0_rgba(31,38,135,0.07)] 
                        ${!isClicked ? 'hover:shadow-[0_8px_32px_0_rgba(31,38,135,0.2),inset_0_0_0_1px_rgba(255,255,255,0.2)] hover:bg-white/30 dark:hover:bg-[#1a1a1a]/90 hover:-translate-y-1 active:scale-[0.98]' : ''}
                        ${isClicked ? 'scale-[0.96] ring-2 ring-white/50 bg-white/40 dark:bg-[#2a2a2a]' : ''}
                        overflow-hidden ${isReordering ? 'ring-2 ring-blue-500/50 shadow-xl' : ''}`}>
                        <div className="absolute inset-0 bg-gradient-to-br from-transparent via-white/10 to-transparent dark:via-white/5 bg-[length:200%_200%] animate-gradient-x pointer-events-none opacity-50 mix-blend-overlay" style={{ animationDuration: '8s' }} />
                        <div className="absolute inset-0 bg-gradient-to-br from-white/40 dark:from-white/5 via-transparent to-transparent opacity-60 dark:opacity-20 pointer-events-none group-hover:opacity-80 dark:group-hover:opacity-40 transition-opacity duration-500" />
                        <div className="absolute top-0 left-0 right-0 h-2/3 bg-gradient-to-b from-white/20 dark:from-white/5 to-transparent opacity-50 dark:opacity-10 pointer-events-none" />
                        <div className="absolute -bottom-1/2 -right-1/2 w-full h-full bg-gradient-to-t from-white/20 dark:from-white/5 to-transparent blur-2xl opacity-30 dark:opacity-10 pointer-events-none" />
                        
                        <div className="absolute -right-4 -bottom-4 opacity-5 dark:opacity-5 group-hover:opacity-10 dark:group-hover:opacity-10 transition-opacity duration-500 pointer-events-none transform rotate-12 scale-150">
                                <IconComponent className={`w-32 h-32 ${styles.text}`} />
                        </div>

                        {isReordering && (
                            <div className="absolute -top-1 -left-1 w-5 h-5 bg-white dark:bg-gray-700 rounded-full flex items-center justify-center shadow-md animate-none z-30">
                                <div className="w-2 h-0.5 bg-gray-400 dark:bg-gray-300 rounded-full"></div>
                            </div>
                        )}

                        <div className="flex flex-col items-start text-left z-10 w-full pointer-events-none">
                            <div className="flex items-center gap-2 sm:gap-3 mb-1">
                                <div className={`w-6 h-6 sm:w-8 sm:h-8 rounded-full ${styles.decoration} bg-opacity-30 dark:bg-opacity-40 flex items-center justify-center shrink-0 shadow-md dark:shadow-lg dark:shadow-black/50 group-hover:scale-110 transition-transform duration-300`}>
                                        <IconComponent className={`w-3.5 h-3.5 sm:w-4 sm:h-4 ${styles.price} drop-shadow-md font-bold`} />
                                </div>
                                <span className={`font-bold text-xs sm:text-base text-gray-900 dark:text-gray-50 leading-tight ${styles.cardHoverText} transition-colors drop-shadow-sm`}>{title}</span>
                            </div>
                            <div className="ml-8 sm:ml-11 text-xs text-gray-700 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-gray-200 font-mono font-semibold uppercase tracking-wider transition-colors z-20">{rateDescription}</div>
                        </div>
                        <div className="w-full flex justify-end mt-1 sm:mt-2 z-10 pointer-events-none">
                            <span className={`text-lg sm:text-3xl font-black font-mono text-gray-900 dark:text-white ${styles.cardHoverText} group-hover:scale-110 inline-block origin-right transition-transform duration-300 drop-shadow-md`}>${price.toFixed(0)}</span>
                        </div>
                    </div>
                </div>
            );
        };

        const QuotationModal = ({ isOpen, data, onClose, onAddToQuote, opacityLevel }) => {
            const [isVisible, setIsVisible] = useState(false);
            const [isAnimating, setIsAnimating] = useState(false);
            const [copied, setCopied] = useState(false);
            const [isAdded, setIsAdded] = useState(false);
            
            useEffect(() => {
                if (isOpen) {
                    setIsVisible(true);
                    requestAnimationFrame(() => setIsAnimating(true));
                    setCopied(false);
                    setIsAdded(false);
                } else {
                    setIsAnimating(false);
                    const timer = setTimeout(() => setIsVisible(false), 300);
                    return () => clearTimeout(timer);
                }
            }, [isOpen]);

            const handleShare = async () => {
                if (!data) return;
                const textToCopy = `Halo Design Hub Quotation\nItem: ${data.title}\nDimensions: ${data.originalWidth} (w) x ${data.originalHeight} (h) ${data.unit}\nPrice: $${data.totalPrice.toFixed(2)}`;
                try {
                    await navigator.clipboard.writeText(textToCopy);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                } catch (err) { console.error(err); }
            };

            const handleAdd = () => {
                if (isAdded) return;
                setIsAdded(true);
                setTimeout(() => {
                    onAddToQuote();
                }, 500);
            };

            if (!isVisible) return null;
            const styles = data ? THEME_STYLES[data.colorTheme] || THEME_STYLES.gray : THEME_STYLES.gray;

            return (
                <div className={`fixed inset-0 z-50 flex items-center justify-center p-4 transition-all duration-500 perspective-1000 ${isAnimating ? 'bg-black/10 backdrop-blur-[2px]' : 'bg-black/0 backdrop-blur-none'}`} onClick={onClose}>
                    <div onClick={(e) => e.stopPropagation()} className={`w-full max-w-lg p-8 relative rounded-2xl shadow-lg md:shadow-2xl watermark-container overflow-hidden transform transition-all duration-300 md:duration-500 cubic-bezier(0.34, 1.56, 0.64, 1) bg-white dark:bg-zinc-900 border border-white/30 dark:border-white/10 md:backdrop-blur-2xl ${isAnimating ? 'scale-100 opacity-100 translate-y-0 rotate-x-0' : 'scale-90 opacity-0 translate-y-24 rotate-x-12'}`} style={{ '--tw-bg-opacity': opacityLevel }}>
                        <button onClick={onClose} className="absolute top-4 right-4 z-50 text-gray-500 dark:text-gray-400 hover:text-red-500 transition-all p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 hover:rotate-90 active:scale-90"><X className="w-6 h-6" /></button>
                        <h3 className="text-2xl font-black mb-6 border-b border-gray-800/10 dark:border-white/10 pb-4 uppercase tracking-tight drop-shadow-sm text-gray-900 dark:text-white">Quotation</h3>
                        {data ? (
                            <div className="space-y-6 relative z-10">
                                <div className={`p-5 rounded-xl shadow-sm ${styles.decoration} bg-opacity-10 dark:bg-opacity-10 border ${styles.border}`}>
                                    <p className={`text-[10px] ${styles.text} uppercase tracking-[0.2em] font-bold mb-2 opacity-70`}>Item Selection</p>
                                    <div className={`text-xl font-bold font-mono break-words leading-tight text-3d ${styles.text}`}>{data.title}</div>
                                </div>
                                <div className={`p-5 rounded-xl shadow-sm ${styles.decoration} bg-opacity-10 dark:bg-opacity-10 border ${styles.border}`}>
                                    <p className={`text-[10px] ${styles.text} uppercase tracking-[0.2em] font-bold mb-2 opacity-70`}>Dimensions</p>
                                    <div className={`text-lg font-bold ${styles.text} font-mono`}>{data.originalWidth} (w) x {data.originalHeight} (h) {data.unit}</div>
                                </div>
                                <div className="pt-6 border-t border-gray-800/10 dark:border-white/10 flex justify-between items-end">
                                    <p className="font-bold text-lg text-gray-700 dark:text-gray-300 mb-1">Price</p>
                                    <div className={`text-5xl font-black font-mono tracking-tight drop-shadow-md ${styles.price}`}>${data.totalPrice.toFixed(2)}</div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={handleAdd} disabled={isAdded} className={`w-full py-3 rounded-lg font-bold font-mono text-sm uppercase tracking-wider shadow-lg transition-all duration-300 flex items-center justify-center gap-2 active:scale-95 ${isAdded ? 'bg-green-500 text-white scale-95' : 'bg-gray-900 text-white dark:bg-white dark:text-gray-900 hover:scale-[1.02] hover:shadow-xl'}`}>
                                        {isAdded ? <><Check className="w-5 h-5" /> Added</> : <><Plus className="w-5 h-5" /> Add to List</>}
                                    </button>
                                    <button onClick={handleShare} className={`w-full py-3 rounded-lg font-bold font-mono text-sm uppercase tracking-wider border transition-all flex items-center justify-center gap-2 active:scale-95 ${copied ? 'bg-green-500/20 text-green-700 border-green-500/30' : 'bg-white/20 text-gray-700 dark:text-white border-white/40 hover:bg-gray-50 dark:hover:bg-white/10 hover:border-white/60'}`}>
                                        {copied ? 'Copied!' : <><Copy className="w-4 h-4"/> Share</>}
                                    </button>
                                </div>
                            </div>
                        ) : <div className="text-center py-8 text-red-500 font-bold">Invalid dimensions.</div>}
                    </div>
                </div>
            );
        };



        const QuotationList = ({ 
            isOpen, onClose, items, onRemoveItem, onUpdateQuantity, onClearAll, onAddCustomItem, onUpdateItem, onReorderItems, opacityLevel
        }) => {
            const [isVisible, setIsVisible] = useState(false);
            const [isAnimating, setIsAnimating] = useState(false);
            const [copied, setCopied] = useState(false);
            const [showClearConfirm, setShowClearConfirm] = useState(false);
            const [showCustomForm, setShowCustomForm] = useState(false);
            const [formMode, setFormMode] = useState(null);
            const [showSizes, setShowSizes] = useState(true);
            
            // Drag State
            const [draggedItemIndex, setDraggedItemIndex] = useState(null);
            
            const [customName, setCustomName] = useState('');
            const [customWidth, setCustomWidth] = useState('');
            const [customHeight, setCustomHeight] = useState('');
            const [customUnit, setCustomUnit] = useState(Unit.IN);
            const [customPrice, setCustomPrice] = useState('');
            const [customQuantity, setCustomQuantity] = useState('1');
            
            const [docNo, setDocNo] = useState('');
            const [customerName, setCustomerName] = useState('');
            const [customerAddress, setCustomerAddress] = useState('');
            const [contact, setContact] = useState('');
            const [deposit, setDeposit] = useState('');
            const [depositPaid, setDepositPaid] = useState(false);
            const [depositPaidAmount, setDepositPaidAmount] = useState('');
            const [depositPaidDate, setDepositPaidDate] = useState(new Date().toISOString().split('T')[0]);
            const [logo, setLogo] = useState(null);
            const [paymentMethod, setPaymentMethod] = useState('PAYNOW');
            
            const [discountType, setDiscountType] = useState('none');
            const [discountValue, setDiscountValue] = useState(0);

            const grandTotal = items.reduce((sum, item) => sum + (item.totalPrice * item.quantity), 0);
            const discountAmount = discountType === 'percent' ? grandTotal * (discountValue / 100) : (discountType === 'fixed' ? discountValue : 0);
            const finalTotal = Math.max(0, grandTotal - discountAmount);
            
            useEffect(() => {
                if (isOpen) {
                    setIsVisible(true);
                    requestAnimationFrame(() => setIsAnimating(true));
                    setCopied(false);
                    setShowClearConfirm(false);
                    setFormMode(null);
                } else {
                    setIsAnimating(false);
                    const timer = setTimeout(() => setIsVisible(false), 500);
                    return () => clearTimeout(timer);
                }
            }, [isOpen]);

            const handleLogoUpload = (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => { if (event.target?.result) setLogo(event.target.result); };
                    reader.readAsDataURL(e.target.files[0]);
                }
            };

            const handleAddCustom = () => {
                if (!customName || customPrice === '') return;
                const price = parseFloat(customPrice);
                const qty = parseInt(customQuantity);
                if (isNaN(qty) || qty <= 0) return;

                const w = parseFloat(customWidth);
                const h = parseFloat(customHeight);
                const hasDimensions = !isNaN(w) && !isNaN(h) && w > 0 && h > 0;
                
                // Get random color from available themes
                const colorThemes = ['yellow', 'blue', 'indigo', 'cyan', 'orange', 'green', 'purple', 'amber', 'red', 'gold'];
                const randomColor = colorThemes[Math.floor(Math.random() * colorThemes.length)];
                
                onAddCustomItem({
                    id: Date.now().toString(),
                    timestamp: Date.now(),
                    quantity: qty,
                    title: customName,
                    totalPrice: isNaN(price) ? 0 : price,
                    widthInches: 0, heightInches: 0,
                    unit: hasDimensions ? customUnit : Unit.IN,
                    originalWidth: hasDimensions ? w : 0,
                    originalHeight: hasDimensions ? h : 0,
                    colorTheme: randomColor
                });
                setCustomName(''); setCustomPrice(''); setCustomWidth(''); setCustomHeight(''); setCustomQuantity('1'); setShowCustomForm(false);
            };

            const handleShare = async () => {
                if (items.length === 0) return;
                const dateStr = new Date().toLocaleDateString('en-GB');
                let text = `Halo Design Hub Quotation List\nDate: ${dateStr}\n------------------------\n`;
                items.forEach((item, i) => {
                    text += `${i+1}. ${item.title}\n`;
                    if (item.originalWidth > 0) text += `   Size: ${item.originalWidth}(w) x ${item.originalHeight}(h) ${item.unit}\n`;
                    text += `   Qty: ${item.quantity} | Unit: $${item.totalPrice.toFixed(2)}\n`;
                });
                text += `------------------------\n${discountType !== 'none' ? `Subtotal: $${grandTotal.toFixed(2)}\nDiscount: -$${discountAmount.toFixed(2)}\n` : ''}Total: $${finalTotal.toFixed(2)}`;
                try {
                    await navigator.clipboard.writeText(text);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                } catch (e) {}
            };

            // DnD Logic
            const handleDragStart = (e, index) => {
                setDraggedItemIndex(index);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                if (draggedItemIndex === null) return;
                if (draggedItemIndex !== index) {
                    const newItems = [...items];
                    const draggedItem = newItems[draggedItemIndex];
                    newItems.splice(draggedItemIndex, 1);
                    newItems.splice(index, 0, draggedItem);
                    onReorderItems(newItems);
                    setDraggedItemIndex(index);
                }
            };

            const handleDragEnd = () => setDraggedItemIndex(null);

            const handleTouchStart = (e, index) => {
                setDraggedItemIndex(index);
                if (navigator.vibrate) navigator.vibrate(50);
            };

            const handleTouchMove = (e) => {
                if (draggedItemIndex === null) return;
                if (e.cancelable) e.preventDefault();
                
                const touch = e.touches[0];
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                const row = target?.closest('[data-row-index]');
                
                if (row) {
                    const targetIndex = parseInt(row.getAttribute('data-row-index') || '-1');
                    if (targetIndex !== -1 && targetIndex !== draggedItemIndex) {
                        const newItems = [...items];
                        const draggedItem = newItems[draggedItemIndex];
                        newItems.splice(draggedItemIndex, 1);
                        newItems.splice(targetIndex, 0, draggedItem);
                        onReorderItems(newItems);
                        setDraggedItemIndex(targetIndex);
                    }
                }
            };

            const handleTouchEnd = () => setDraggedItemIndex(null);

            const handleGeneratePDF = (action) => {
                const data = { 
                    docNo, 
                    customerName, 
                    customerAddress, 
                    contact, 
                    logo,
                    deposit: parseFloat(deposit) || 0,
                    depositPaid,
                    depositPaidAmount: parseFloat(depositPaidAmount) || 0,
                    depositPaidDate,
                    paymentMethod,
                    showSizes
                };

                try {
                    if (formMode === 'quote') {
                        generateQuotationPDF(items, data, grandTotal, discountAmount, finalTotal, action);
                    } else if (formMode === 'invoice') {
                        generateInvoicePDF(items, data, grandTotal, discountAmount, finalTotal, action);
                    } else {
                        generateReceiptPDF(items, data, grandTotal, discountAmount, finalTotal, action);
                    }
                    if (action === 'save') setFormMode(null);
                } catch (error) {
                    console.error("PDF Generation failed:", error);
                    alert("Failed to generate PDF. Please ensure all details are correct.");
                }
            };

            const getFooterButtonStyles = (type, disabled) => {
                if (disabled) return 'bg-gray-200/20 dark:bg-zinc-800/50 text-gray-400 cursor-not-allowed border border-white/5';

                const base = "col-span-1 py-3.5 rounded-lg font-bold text-xs sm:text-base tracking-wide transition-all duration-200 shadow-md hover:shadow-lg active:scale-95 flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 backdrop-blur-xl border transform";
                let colors = "";
                switch (type) {
                    case 'quote':
                        colors = "bg-red-600 hover:bg-red-500 text-white shadow-red-500/20 border-red-500/40 hover:-translate-y-0.5";
                        break;
                    case 'invoice':
                        colors = "bg-purple-600 hover:bg-purple-500 text-white shadow-purple-500/20 border-purple-500/40 hover:-translate-y-0.5";
                        break;
                    case 'receipt':
                        colors = "bg-indigo-600 hover:bg-indigo-500 text-white shadow-indigo-500/20 border-indigo-500/40 hover:-translate-y-0.5";
                        break;
                    case 'share':
                        if (copied) {
                            colors = "bg-green-600 text-white shadow-green-500/20 border-green-500/50";
                        } else {
                            colors = "bg-zinc-700 hover:bg-zinc-600 text-white shadow-zinc-500/20 border-zinc-600/40 hover:-translate-y-0.5";
                        }
                        break;
                }
                return `${base} ${colors}`;
            };

            const getGenerateButtonStyle = () => {
                return "w-full py-4 rounded-lg font-bold text-sm sm:text-base shadow-lg transition-all duration-200 active:scale-95 flex items-center justify-center gap-2 h-[50px] sm:h-[56px] bg-red-600 hover:bg-red-500 text-white backdrop-blur-md border border-red-500/30 shadow-red-500/20 hover:shadow-red-500/40 hover:-translate-y-0.5";
            };

            const getPreviewButtonStyle = () => {
                return "w-full py-4 rounded-lg font-bold text-sm sm:text-base shadow-lg transition-all duration-200 active:scale-95 flex items-center justify-center gap-2 h-[50px] sm:h-[56px] bg-white/80 dark:bg-white/10 hover:bg-white dark:hover:bg-white/20 text-gray-800 dark:text-white backdrop-blur-md border border-white/40 dark:border-white/10 hover:shadow-xl hover:-translate-y-0.5";
            };

            const getInputStyle = () => {
                return "bg-black/5 dark:bg-zinc-800/80 backdrop-blur-sm focus:bg-white/90 dark:focus:bg-zinc-700 border-gray-400/50 dark:border-zinc-600 text-gray-900 dark:text-gray-100 placeholder-gray-600 dark:placeholder-gray-500 focus:ring-2 focus:ring-[#C1D82F]/50 shadow-sm";
            };
            
            const getHeaderStyle = () => {
                return "bg-white/50 dark:bg-black/40 backdrop-blur-sm border-gray-200/50 dark:border-white/10";
            };

            if (!isVisible) return null;

            return (
                <div className={`fixed inset-0 z-[60] flex items-center justify-center p-4 transition-all duration-500 perspective-1000 ${isAnimating ? 'bg-black/10 backdrop-blur-[2px]' : 'bg-black/0 backdrop-blur-none pointer-events-none'}`} onClick={onClose}>
                    <div 
                        onClick={(e) => e.stopPropagation()} 
                        className={`w-full max-w-5xl h-[90vh] flex flex-col shadow-lg md:shadow-2xl rounded-2xl overflow-hidden transform transition-all duration-300 md:duration-500 ring-1 ring-black/5 relative bg-white dark:bg-zinc-900 border-white/30 dark:border-white/10 md:backdrop-blur-2xl ${isAnimating ? 'scale-100 opacity-100 translate-y-0' : 'scale-95 opacity-0 translate-y-8'}`}
                        style={{ '--tw-bg-opacity': opacityLevel }}
                    >
                        
                        <div className={`flex flex-col h-full ${formMode ? 'invisible' : ''}`}>
                            <div className="h-14 px-4 border-b border-gray-300/30 dark:border-white/10 flex justify-between items-center bg-white/60 dark:bg-white/5 shrink-0 draggable relative">
                                <div className="flex gap-2 items-center z-10">
                                    <div className="flex gap-2 group mr-4">
                                        <button onClick={onClose} className="w-3 h-3 rounded-full bg-red-500 hover:bg-red-600 active:scale-90 border border-red-600/20 flex items-center justify-center transition-all duration-200 group-hover:shadow-md"><div className="opacity-0 group-hover:opacity-100"><X className="w-2 h-2 text-red-900" /></div></button>
                                        <button className="w-3 h-3 rounded-full bg-yellow-500 border border-yellow-600/20 cursor-default"></button>
                                        <button className="w-3 h-3 rounded-full bg-green-500 border border-green-600/20 cursor-default"></button>
                                    </div>
                                </div>
                                
                                <h2 className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-sm font-semibold text-gray-800 dark:text-white tracking-tight pointer-events-none drop-shadow-sm">ITEM LIST</h2>

                                <div className="flex gap-2 z-10">
                                    <button 
                                        onClick={() => setShowCustomForm(!showCustomForm)} 
                                        className={`p-2 rounded-lg transition-all duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)] active:scale-90 ${
                                            showCustomForm 
                                            ? 'bg-[#C1D82F] text-black rotate-[135deg] shadow-lg shadow-[#C1D82F]/40 hover:bg-[#b0c62b]' 
                                            : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10 hover:text-[#C1D82F] dark:hover:text-[#C1D82F] hover:rotate-90'
                                        }`} 
                                        title={showCustomForm ? "Close Form" : "Add Custom Item"}
                                    >
                                        <Plus className="w-5 h-5" />
                                    </button>
                                    <button onClick={() => items.length > 0 && setShowClearConfirm(true)} disabled={items.length === 0} className={`p-1.5 rounded-md transition-all duration-200 active:scale-90 ${items.length === 0 ? 'opacity-30 cursor-not-allowed' : 'hover:bg-red-100 dark:hover:bg-red-900/30 text-gray-500 hover:text-red-500'}`} title="Clear All"><Trash className="w-5 h-5" /></button>
                                </div>
                            </div>

                            <div className="flex-1 relative min-h-0 flex flex-col bg-transparent">
                                <div className={`overflow-hidden transition-all duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)] ${showCustomForm ? 'max-h-[600px] border-b border-gray-200/30 dark:border-white/10 opacity-100 translate-y-0' : 'max-h-0 opacity-0 -translate-y-4'}`}>
                                    <div className="p-4 bg-white/20 dark:bg-black/20 space-y-3">
                                        <div className="flex gap-2 w-full">
                                            <div className="flex-1 bg-white/30 dark:bg-zinc-800/80 rounded-lg focus-within:ring-2 focus-within:ring-[#C1D82F]/50 transition-all border border-transparent focus-within:border-[#C1D82F]/30 shadow-sm">
                                                <input type="text" value={customName} onChange={e => setCustomName(e.target.value)} placeholder="Item Name" className="w-full p-2.5 text-sm bg-transparent border-none outline-none placeholder-gray-600 dark:placeholder-gray-500 text-gray-900 dark:text-gray-100 font-semibold" />
                                            </div>
                                            <div className="relative w-[140px] sm:w-[180px] bg-transparent border border-white/20 dark:border-white/10 rounded-lg backdrop-blur-md hover:bg-white/5 transition-colors group shadow-sm">
                                                <select 
                                                    onChange={(e) => { 
                                                        const i = PRESET_ITEMS.find(p => p.name === e.target.value); 
                                                        if(i) { 
                                                            setCustomName(i.name); 
                                                            setCustomPrice(i.price.toString()); 
                                                        } 
                                                    }} 
                                                    className="w-full h-full p-2.5 pr-8 text-xs sm:text-sm font-medium bg-transparent border-none outline-none appearance-none truncate text-gray-800 dark:text-gray-100 cursor-pointer" 
                                                    value=""
                                                >
                                                    <option value="" disabled className="hidden">Select Items</option>
                                                    {PRESET_ITEMS.map(i => <option key={i.name} value={i.name} className="bg-white dark:bg-zinc-800 text-black dark:text-white">{i.name}</option>)}
                                                </select>
                                                <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500 group-hover:text-gray-700 dark:group-hover:text-white transition-colors"><ChevronDown className="w-4 h-4" /></div>
                                            </div>
                                        </div>
                                        <div className="flex flex-col sm:flex-row gap-3">
                                            <div className="flex gap-2 w-full sm:flex-1">
                                                <input type="number" value={customWidth} onChange={e => setCustomWidth(e.target.value)} placeholder="W" className="w-1/3 p-2 text-sm bg-white/30 dark:bg-zinc-800/80 rounded-lg border-none outline-none focus:ring-2 focus:ring-[#C1D82F]/50 text-gray-900 dark:text-gray-100 font-mono font-bold shadow-sm" />
                                                <input type="number" value={customHeight} onChange={e => setCustomHeight(e.target.value)} placeholder="H" className="w-1/3 p-2 text-sm bg-white/30 dark:bg-zinc-800/80 rounded-lg border-none outline-none focus:ring-2 focus:ring-[#C1D82F]/50 text-gray-900 dark:text-gray-100 font-mono font-bold shadow-sm" />
                                                <select value={customUnit} onChange={e => setCustomUnit(e.target.value)} className="w-1/3 p-2 bg-white/30 dark:bg-zinc-800/80 rounded-lg border-none outline-none text-xs text-gray-800 dark:text-gray-100 font-mono font-bold shadow-sm cursor-pointer">
                                                    <option value={Unit.IN} className="bg-white dark:bg-zinc-800">in</option>
                                                    <option value={Unit.FT} className="bg-white dark:bg-zinc-800">ft</option>
                                                    <option value={Unit.CM} className="bg-white dark:bg-zinc-800">cm</option>
                                                    <option value={Unit.MM} className="bg-white dark:bg-zinc-800">mm</option>
                                                </select>
                                            </div>
                                            <div className="flex gap-2 w-full sm:w-auto">
                                                <input type="number" value={customQuantity} onChange={e => setCustomQuantity(e.target.value)} placeholder="Qty" className="w-16 p-2 text-sm bg-white/30 dark:bg-zinc-800/80 rounded-lg border-none outline-none focus:ring-2 focus:ring-[#C1D82F]/50 text-gray-900 dark:text-gray-100 font-mono font-bold shadow-sm" />
                                                <input type="number" value={customPrice} onChange={e => setCustomPrice(e.target.value)} placeholder="Price" className="flex-1 min-w-[80px] p-2 text-sm bg-white/30 dark:bg-zinc-800/80 rounded-lg border-none outline-none focus:ring-2 focus:ring-[#C1D82F]/50 text-gray-900 dark:text-gray-100 font-mono font-bold shadow-sm" />
                                                <button onClick={handleAddCustom} disabled={!customName || parseInt(customQuantity) <= 0} className="px-4 py-2 bg-[#C1D82F] hover:bg-[#b0c62b] active:bg-[#a3b627] active:scale-95 text-black rounded-lg text-xs font-bold transition-all shadow-sm disabled:opacity-50 flex items-center justify-center gap-1 hover:shadow-md"><Plus className="w-3 h-3" />Add</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div 
                                    className="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar touch-pan-y" 
                                    onTouchMove={handleTouchMove} 
                                    onTouchEnd={handleTouchEnd}
                                >
                                    {items.length === 0 && !showCustomForm && (
                                        <div className="h-full flex flex-col items-center justify-center text-gray-400 dark:text-gray-500"><div className="w-16 h-16 mb-4 opacity-20"><FileText className="w-full h-full"/></div><p className="text-sm font-medium">No items in the list</p></div>
                                    )}
                                    {items.map((item, index) => {
                                        const colorTheme = item.colorTheme || 'gray';
                                        const styles = THEME_STYLES[colorTheme] || THEME_STYLES.gray;
                                        const isDragging = draggedItemIndex === index;
                                        return (
                                            <div 
                                                key={item.id} 
                                                data-row-index={index}
                                                draggable
                                                onDragStart={(e) => handleDragStart(e, index)}
                                                onDragOver={(e) => handleDragOver(e, index)}
                                                onDragEnd={handleDragEnd}
                                                className={`group relative rounded-lg p-2 sm:p-3 shadow-sm border flex gap-2 sm:gap-4 items-center transition-all duration-200 
                                                    ${styles.modalBg} ${styles.modalBorder} 
                                                    ${isDragging ? 'z-50 scale-[1.02] shadow-xl ring-2 ring-[#C1D82F]/50 cursor-grabbing opacity-90' : 'hover:shadow-md hover:scale-[1.005] hover:brightness-105 cursor-auto'}
                                                    select-none`}
                                            >
                                                <div 
                                                    className="p-2 -ml-2 cursor-grab touch-none text-gray-500 hover:text-gray-700 active:cursor-grabbing active:text-[#C1D82F] transition-colors"
                                                    onTouchStart={(e) => {
                                                        e.stopPropagation();
                                                        handleTouchStart(e, index);
                                                    }}
                                                >
                                                    <GripVertical className="w-5 h-5" />
                                                </div>

                                                <div className="flex-1 min-w-0">
                                                    <div className="mb-1 w-full relative flex items-center gap-2">
                                                        <div className={`w-2 h-2 rounded-full ${styles.decoration} shrink-0`}></div>
                                                        <input 
                                                            type="text" 
                                                            value={item.title} 
                                                            onChange={(e) => onUpdateItem(item.id, { title: e.target.value })}
                                                            className={`w-full font-bold text-xs sm:text-sm leading-tight uppercase bg-transparent border-b border-transparent focus:border-current hover:border-gray-300 dark:hover:border-gray-600 outline-none transition-colors rounded-none px-0 py-0.5 text-gray-800 dark:text-gray-100 ${styles.inputFocus} placeholder-gray-400`}
                                                            placeholder="Description"
                                                            onPointerDown={(e) => e.stopPropagation()}
                                                        />
                                                    </div>
                                                    {item.originalWidth > 0 ? <div className="flex flex-wrap items-center gap-1 sm:gap-2 text-xs text-gray-600 dark:text-gray-400 font-mono ml-4"><span className="bg-white/30 dark:bg-white/5 px-1.5 rounded font-bold">{item.originalWidth}x{item.originalHeight} {item.unit}</span><span className="opacity-50 hidden sm:inline">|</span><span>${item.totalPrice.toFixed(2)}/ea</span></div> : <div className="text-xs text-gray-600 dark:text-gray-400 font-mono ml-4 font-bold">${item.totalPrice.toFixed(2)}/ea</div>}
                                                </div>
                                                <div className="flex items-center gap-2 sm:gap-4">
                                                    <div className="flex flex-col items-end"><label className="text-[10px] text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider mb-0.5">Qty</label><input type="number" min="0" value={item.quantity === 0 ? '' : item.quantity} onChange={(e) => { const val = parseInt(e.target.value); onUpdateQuantity(item.id, isNaN(val) ? -item.quantity : val - item.quantity); }} onBlur={() => { if (item.quantity === 0) onUpdateQuantity(item.id, 1 - item.quantity); }} onFocus={(e) => e.target.select()} onPointerDown={(e) => e.stopPropagation()} className={`w-10 sm:w-16 p-1 sm:p-1.5 text-right text-xs sm:text-sm font-mono font-bold bg-white/40 dark:bg-white/5 rounded-md border border-white/20 dark:border-white/10 outline-none focus:ring-2 focus:ring-[#C1D82F]/50 transition-all text-gray-900 dark:text-white ${styles.inputFocus}`} /></div>
                                                    <div className="text-right w-[75px] sm:w-[100px]"><label className="text-[10px] text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider mb-0.5 block">Total</label><div className="relative group/input"><span className="absolute left-1.5 sm:left-2 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400 text-xs font-mono pointer-events-none transition-colors group-focus-within/input:text-[#C1D82F]">$</span><input type="number" min="0" step="0.01" value={item.quantity === 0 ? 0 : Math.round(item.totalPrice * item.quantity * 100) / 100} onChange={(e) => { const val = parseFloat(e.target.value); if (!isNaN(val) && val >= 0) { if (item.quantity === 0) { onUpdateItem(item.id, { quantity: 1, totalPrice: val }); } else { onUpdateItem(item.id, { totalPrice: val / item.quantity }); } } }} onFocus={(e) => e.target.select()} onPointerDown={(e) => e.stopPropagation()} className={`w-full pl-4 sm:pl-5 pr-1 sm:pr-2 py-1.5 text-right font-bold text-gray-900 dark:text-white font-mono text-xs sm:text-base bg-white/40 dark:bg-white/5 rounded-md border border-white/20 dark:border-white/10 outline-none focus:ring-2 focus:ring-[#C1D82F]/50 transition-all placeholder-gray-400/50 shadow-inner ${styles.inputFocus}`} placeholder="0.00" /></div></div>
                                                    <button onClick={() => onRemoveItem(item.id)} className="w-6 h-6 sm:w-8 sm:h-8 rounded-full flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 active:scale-90 transition-all opacity-0 group-hover:opacity-100 focus:opacity-100" title="Remove Item"><Trash className="w-3 h-3 sm:w-4 sm:h-4"/></button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="p-4 bg-white/10 dark:bg-black/20 border-t border-white/20 dark:border-white/10 backdrop-blur-md">
                                <div className="flex flex-col gap-4">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-2"><span className="text-xs font-semibold text-red-500 uppercase tracking-wide">Discount</span><div className="flex bg-white/20 dark:bg-white/5 rounded-lg p-0.5"><button onClick={() => {setDiscountType('percent'); setDiscountValue(5)}} className={`px-2.5 py-1 text-xs rounded-md transition-all font-medium ${discountType==='percent'&&discountValue===5 ? 'bg-white dark:bg-white/20 shadow-sm text-gray-900 dark:text-white transform scale-105' : 'text-gray-500 hover:text-gray-900 dark:hover:text-gray-300 hover:bg-white/10'} active:scale-95`}>5%</button><button onClick={() => {setDiscountType('percent'); setDiscountValue(10)}} className={`px-2.5 py-1 text-xs rounded-md transition-all font-medium ${discountType==='percent'&&discountValue===10 ? 'bg-white dark:bg-white/20 shadow-sm text-gray-900 dark:text-white transform scale-105' : 'text-gray-500 hover:text-gray-900 dark:hover:text-gray-300 hover:bg-white/10'} active:scale-95`}>10%</button></div><div className="relative group"><span className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">$</span><input type="number" value={discountType==='fixed'?discountValue:''} onChange={e => {setDiscountType('fixed'); setDiscountValue(parseFloat(e.target.value)||0)}} placeholder="0" className="w-20 py-1 pl-4 pr-2 text-xs bg-white/30 dark:bg-zinc-800 rounded-md border-none outline-none focus:ring-1 focus:ring-[#C1D82F] text-right font-mono text-gray-900 dark:text-white transition-all focus:bg-white/50 dark:focus:bg-zinc-700" /></div></div>
                                        <div className="text-right"><div className="text-xs text-gray-500 dark:text-gray-400 mb-1 mr-1">Total Amount</div><div className="text-2xl sm:text-3xl font-bold font-mono text-gray-900 dark:text-white tracking-tight mr-1">${finalTotal.toFixed(2)}</div>{discountAmount > 0 && <div className="text-xs font-bold text-red-500 font-mono mt-1 mr-1">Discount: -${discountAmount.toFixed(2)}</div>}</div>
                                    </div>
                                    <div className="grid grid-cols-4 gap-3">
                                        <button onClick={() => setFormMode('quote')} disabled={items.length===0} className={getFooterButtonStyles('quote', items.length === 0)}><FileText className="w-5 h-5"/><span>QUOTE</span></button>
                                        <button onClick={() => setFormMode('invoice')} disabled={items.length===0} className={getFooterButtonStyles('invoice', items.length === 0)}><FileText className="w-5 h-5"/><span>INVOICE</span></button>
                                        <button onClick={() => setFormMode('receipt')} disabled={items.length===0} className={getFooterButtonStyles('receipt', items.length === 0)}><FileText className="w-5 h-5"/><span>RECEIPT</span></button>
                                        <button onClick={handleShare} disabled={items.length===0} className={getFooterButtonStyles('share', items.length === 0)}>{copied ? <><Check className="w-4 h-4"/><span>COPIED</span></> : <><Share2 className="w-4 h-4"/><span>SHARE</span></>}</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {formMode && (
                            <div className="absolute inset-0 z-50 flex flex-col animate-fade-in">
                                <div className={`flex items-center justify-between p-4 border-b shrink-0 ${getHeaderStyle()}`}>
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => setFormMode(null)} className="p-2 -ml-2 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors flex items-center gap-1 active:scale-95" title="Back to Item List"><ChevronLeft className="w-5 h-5" /><span className="text-sm font-semibold hidden sm:inline">Back</span></button>
                                        <h3 className="text-lg font-bold text-gray-900 dark:text-white ml-2 flex items-center gap-2">{formMode === 'quote' ? 'Quotation Details' : formMode === 'invoice' ? 'Invoice Details' : 'Receipt Details'}</h3>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 sm:p-6 custom-scrollbar">
                                    <div className="max-w-2xl mx-auto space-y-5">
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <div className="space-y-1.5"><label className="text-sm sm:text-base font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wider">{formMode === 'quote' ? 'Quotation To' : formMode === 'invoice' ? 'Bill To' : 'Received From'}</label><input type="text" value={customerName} onChange={e => setCustomerName(e.target.value)} className={`w-full p-3 sm:p-4 text-sm sm:text-base font-sans rounded-lg outline-none focus:ring-2 focus:ring-[#C1D82F]/50 transition-all ${getInputStyle()}`} placeholder="Enter customer name" /></div>
                                            <div className="space-y-1.5"><label className="text-sm sm:text-base font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wider">{formMode === 'quote' ? 'Quotation No' : formMode === 'invoice' ? 'Invoice No' : 'Receipt No'}</label><input type="text" value={docNo} onChange={e => setDocNo(e.target.value)} className={`w-full p-3 sm:p-4 text-sm sm:text-base rounded-lg outline-none focus:ring-2 focus:ring-[#C1D82F]/50 transition-all font-mono ${getInputStyle()}`} placeholder={formMode === 'quote' ? 'Draft' : formMode === 'invoice' ? 'INV001' : '84224'} /></div>
                                        </div>
                                        <div className="space-y-1.5"><label className="text-sm sm:text-base font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wider">Location</label><textarea value={customerAddress} onChange={e => setCustomerAddress(e.target.value)} className={`w-full p-3 sm:p-4 text-sm sm:text-base font-sans rounded-lg outline-none focus:ring-2 focus:ring-[#C1D82F]/50 resize-none h-24 transition-all ${getInputStyle()}`} placeholder="Enter address details" /></div>
                                        
                                        <div className="space-y-1.5"><label className="text-sm sm:text-base font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wider">Contact</label><input type="text" value={contact} onChange={e => setContact(e.target.value)} className={`w-full p-3 sm:p-4 text-sm sm:text-base font-sans rounded-lg outline-none focus:ring-2 focus:ring-[#C1D82F]/50 transition-all ${getInputStyle()}`} placeholder="Enter contact" /></div>
                                        
                                        {formMode !== 'quote' && (
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <div className="space-y-1.5">
                                                <label className="text-sm sm:text-base font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wider">Deposit Amount</label>
                                                <div className="flex gap-2">
                                                    <div className="relative flex-1">
                                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400 font-mono">$</span>
                                                        <input type="number" value={deposit} onChange={e => setDeposit(e.target.value)} className={`w-full p-3 sm:p-4 pl-8 text-sm sm:text-base rounded-lg outline-none focus:ring-2 focus:ring-[#C1D82F]/50 transition-all font-mono ${getInputStyle()}`} placeholder="0.00" />
                                                    </div>
                                                    <div className="relative flex-1">
                                                        <select value={paymentMethod} onChange={e => setPaymentMethod(e.target.value)} className={`w-full h-full p-3 sm:p-4 text-xs sm:text-sm rounded-lg outline-none focus:ring-2 focus:ring-[#C1D82F]/50 font-medium appearance-none cursor-pointer ${getInputStyle()}`}>
                                                            <option value="CASH">CASH</option>
                                                            <option value="PAYNOW">PAYNOW</option>
                                                            <option value="BANK TRANSFER">BANK TRANSFER</option>
                                                            <option value="CHEQUE">CHEQUE</option>
                                                        </select>
                                                        <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500"><ChevronDown className="w-4 h-4" /></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="space-y-3">
                                                <div className={`flex items-center justify-between p-2.5 sm:p-3.5 rounded-lg border transition-all ${getInputStyle()}`}>
                                                    <label className="text-sm sm:text-base font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wider">Mark as Paid</label>
                                                    <button onClick={() => {
                                                        const newState = !depositPaid;
                                                        setDepositPaid(newState);
                                                        if (newState) {
                                                            const depositAmount = parseFloat(deposit) || 0;
                                                            const paidAmount = depositAmount > 0 ? finalTotal - depositAmount : finalTotal;
                                                            setDepositPaidAmount(paidAmount.toString());
                                                        }
                                                    }} className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-[#C1D82F]/50 ${depositPaid ? 'bg-[#C1D82F]' : 'bg-gray-300 dark:bg-gray-600'}`}><span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${depositPaid ? 'translate-x-6' : 'translate-x-1'}`} /></button>
                                                </div>
                                                {depositPaid && (
                                                    <>
                                                        <div className="space-y-1.5">
                                                            <label className="text-sm sm:text-base font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wider">Paid Amount</label>
                                                            <div className="relative">
                                                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400 font-mono">$</span>
                                                                <div className={`w-full p-3 sm:p-4 pl-8 text-sm sm:text-base rounded-lg font-mono ${getInputStyle()}`}>{parseFloat(depositPaidAmount || 0).toFixed(2)}</div>
                                                            </div>
                                                        </div>
                                                        <div className="space-y-1.5">
                                                            <label className="text-sm sm:text-base font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wider">Date Paid</label>
                                                            <input type="date" value={depositPaidDate} onChange={e => setDepositPaidDate(e.target.value)} className={`w-full p-3 sm:p-4 text-sm sm:text-base rounded-lg outline-none focus:ring-2 focus:ring-[#C1D82F]/50 transition-all font-mono ${getInputStyle()}`} />
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                        )}
                                        
                                        <div className="flex flex-col sm:flex-row gap-4 items-end pt-2">
                                            <div className="w-full sm:w-1/2 space-y-3">
                                                <div className={`flex items-center justify-between p-2.5 sm:p-3.5 rounded-lg border transition-all ${getInputStyle()}`}>
                                                    <label className="text-xs sm:text-sm font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wider">Show Sizes</label>
                                                    <button onClick={() => setShowSizes(!showSizes)} className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-[#C1D82F]/50 ${showSizes ? 'bg-[#C1D82F]' : 'bg-gray-300 dark:bg-gray-600'}`}><span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${showSizes ? 'translate-x-6' : 'translate-x-1'}`} /></button>
                                                </div>
                                                <div className="space-y-1.5">
                                                    <label className="text-sm sm:text-base font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wider">Logo</label>
                                                    <label className={`flex items-center gap-3 p-2.5 sm:p-3.5 border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-zinc-800 transition-all group active:scale-[0.99] ${getInputStyle()}`}>
                                                        <div className="w-10 h-10 sm:w-12 sm:h-12 rounded-md bg-gray-100 dark:bg-zinc-700 flex items-center justify-center text-gray-400 group-hover:text-[#C1D82F] transition-colors overflow-hidden border border-gray-200 dark:border-white/5 shrink-0">{logo ? <img src={logo} alt="Logo" className="w-full h-full object-contain" /> : <Plus className="w-5 h-5"/>}</div>
                                                        <div className="flex-1 min-w-0"><p className="text-xs sm:text-sm font-semibold text-gray-900 dark:text-gray-100 truncate">{logo ? 'Selected' : 'Upload'}</p><p className="text-[10px] sm:text-xs text-gray-500 dark:text-gray-400 truncate">PNG recom.</p></div>
                                                        <input type="file" accept="image/*" onChange={handleLogoUpload} className="hidden" />
                                                    </label>
                                                </div>
                                            </div>
                                            <div className="w-full sm:w-1/2 flex gap-2">
                                                <button onClick={() => handleGeneratePDF('view')} className={getPreviewButtonStyle()} title="View Preview">
                                                    <Eye className="w-5 h-5" />
                                                    <span className="hidden sm:inline">View</span>
                                                </button>
                                                <button onClick={() => handleGeneratePDF('save')} className={getGenerateButtonStyle()} title="Generate PDF">
                                                    <Download className="w-5 h-5" />
                                                    <span className="hidden sm:inline">Save</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showClearConfirm && (
                            <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm animate-fade-in">
                                <div className="bg-white dark:bg-[#2c2c2e] p-6 rounded-2xl shadow-2xl max-w-sm w-full m-4 transform scale-100 transition-transform border border-gray-200 dark:border-white/10">
                                    <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-2">Clear List?</h3>
                                    <p className="text-sm text-gray-500 dark:text-gray-400 mb-6">Are you sure you want to remove all items from your quotation list? This action cannot be undone.</p>
                                    <div className="flex gap-3">
                                        <button onClick={() => setShowClearConfirm(false)} className="flex-1 py-2.5 rounded-lg font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-white/10 hover:bg-gray-200 dark:hover:bg-white/20 transition-colors active:scale-95">Cancel</button>
                                        <button onClick={() => { onClearAll(); setShowClearConfirm(false); }} className="flex-1 py-2.5 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 transition-colors active:scale-95">Clear All</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ControlGroup = ({ quoteItems, setQuoteListOpen, setOpacityLevel, opacityLevel, theme, setTheme, className = "" }) => {
            
            const OpacityToggle = ({ value, onChange, currentTheme }) => {
                const isSolid = value >= 0.99;
                return (
                    <button onClick={() => onChange(isSolid ? 0.5 : 1.0)} className="relative w-9 h-9 sm:w-12 sm:h-12 rounded-full focus:outline-none group active:scale-95 transition-transform duration-300" aria-label="Toggle Opacity" title={isSolid ? "Switch to 50% Opacity" : "Switch to 100% Opacity"}>
                        <div className={`absolute inset-0 rounded-full flex items-center justify-center transition-all duration-500 overflow-hidden
                            ${currentTheme === Theme.DARK 
                                ? 'bg-black/80 shadow-[0_0_25px_rgba(168,85,247,0.7),inset_0_0_10px_rgba(168,85,247,0.3)] border border-purple-500/60' 
                                : 'bg-gradient-to-br from-white/60 via-white/10 to-transparent backdrop-blur-xl border border-white/40 shadow-[inset_0_2px_4px_rgba(255,255,255,0.5),0_8px_16px_-4px_rgba(0,0,0,0.1)] hover:scale-105 hover:shadow-[inset_0_2px_4px_rgba(255,255,255,0.6),inset_0_-2px_4px_rgba(0,0,0,0.05),0_12px_24px_-4px_rgba(0,0,0,0.15)]'
                            }`}>
                            <Ghost className={`w-4 h-4 sm:w-6 sm:h-6 transition-all duration-300 ${currentTheme === Theme.DARK ? 'text-purple-400 drop-shadow-[0_0_8px_rgba(168,85,247,0.8)]' : 'text-gray-700'}`} style={{ opacity: isSolid ? 1 : 0.5 }} />
                            {/* Additional glow layer for dark mode */}
                            {currentTheme === Theme.DARK && (
                                <div className="absolute inset-0 bg-purple-500 opacity-20 blur-xl rounded-full animate-pulse pointer-events-none"></div>
                            )}
                        </div>
                    </button>
                );
            };

            const ThemeToggle = ({ currentTheme, onToggle }) => (
                <button onClick={onToggle} className="relative w-9 h-9 sm:w-12 sm:h-12 rounded-full focus:outline-none group active:scale-95 transition-transform duration-300" aria-label="Toggle Theme">
                    <div className={`absolute inset-0 rounded-full flex items-center justify-center transition-all duration-500 overflow-hidden
                        ${currentTheme === Theme.DARK 
                            ? 'bg-black/80 shadow-[0_0_25px_rgba(193,216,47,0.7),inset_0_0_10px_rgba(193,216,47,0.3)] border border-[#C1D82F]/60' 
                            : 'bg-gradient-to-br from-white/60 via-white/10 to-transparent backdrop-blur-xl border border-white/40 shadow-[inset_0_2px_4px_rgba(255,255,255,0.5),0_8px_16px_-4px_rgba(0,0,0,0.1)]'
                        }`}>
                        <svg width="60%" height="60%" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg" className={`transition-all duration-500 ease-in-out ${currentTheme === Theme.DARK ? 'filter drop-shadow-[0_0_8px_#C1D82F]' : ''}`}>
                            {/* Outer Dashed Ring */}
                            <circle 
                                cx="30" cy="30" r="28" 
                                className={`transition-colors duration-500 ${currentTheme === Theme.DARK ? 'stroke-[#C1D82F] opacity-60' : 'stroke-gray-700'}`} 
                                strokeWidth="4" fill="none" strokeDasharray="12 6" strokeLinecap="round"
                                style={{ 
                                    transformOrigin: 'center', 
                                    transform: currentTheme === Theme.DARK ? 'rotate(180deg)' : 'rotate(0deg)',
                                    transition: 'transform 0.7s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.5s'
                                }}
                            />
                            {/* Middle Thick Ring */}
                            <circle 
                                cx="30" cy="30" r="15" 
                                stroke="#C1D82F" strokeWidth="10" fill="none" 
                                className={`origin-center transition-all duration-500 ${currentTheme === Theme.DARK ? 'opacity-100' : 'opacity-100'}`}
                                style={{ 
                                    transform: currentTheme === Theme.DARK ? 'scale(0.85)' : 'scale(1)',
                                    filter: currentTheme === Theme.DARK ? 'drop-shadow(0 0 4px #C1D82F)' : 'none'
                                }}
                            />
                            {/* Inner Dot - pulses in dark mode */}
                            <circle 
                                cx="30" cy="30" r="5" 
                                className={`transition-all duration-500 ${currentTheme === Theme.DARK ? 'stroke-[#C1D82F] fill-[#C1D82F] animate-pulse' : 'stroke-gray-800 fill-transparent'}`} 
                                strokeWidth="3" 
                            />
                        </svg>
                        {/* Additional glow layer for dark mode */}
                        {currentTheme === Theme.DARK && (
                            <div className="absolute inset-0 bg-[#C1D82F] opacity-20 blur-xl rounded-full animate-pulse pointer-events-none"></div>
                        )}
                    </div>
                </button>
            );



            return (
                <div className={`flex items-center shrink-0 ${className}`}>
                    <button onClick={() => setQuoteListOpen(true)} className="relative w-9 h-9 sm:w-12 sm:h-12 rounded-full focus:outline-none group active:scale-95 transition-transform duration-300" aria-label="View Quotation List" title="View Quotation List">
                        <div className={`absolute inset-0 rounded-full flex items-center justify-center transition-all duration-500 overflow-hidden
                            ${theme === Theme.DARK 
                                ? 'bg-black/80 shadow-[0_0_25px_rgba(249,115,22,0.7),inset_0_0_10px_rgba(249,115,22,0.3)] border border-orange-500/60' 
                                : 'bg-gradient-to-br from-white/60 via-white/10 to-transparent backdrop-blur-xl border border-white/40 shadow-[inset_0_2px_4px_rgba(255,255,255,0.5),0_8px_16px_-4px_rgba(0,0,0,0.1)] group-hover:shadow-[inset_0_2px_4px_rgba(255,255,255,0.6),inset_0_-2px_4px_rgba(0,0,0,0.05),0_12px_24px_-4px_rgba(0,0,0,0.15)] group-hover:scale-105 group-hover:from-white/70'
                            }`}>
                            <List className={`w-4 h-4 sm:w-6 sm:h-6 drop-shadow-sm transition-all duration-300 ${theme === Theme.DARK ? 'text-orange-400 drop-shadow-[0_0_8px_rgba(249,115,22,0.8)]' : 'text-gray-700 group-hover:text-gray-900'}`} />
                            {quoteItems.length > 0 && <span className="absolute -top-1 -right-1 h-3 w-3 sm:h-5 sm:w-5 rounded-full bg-red-500 text-white text-[9px] sm:text-xs flex items-center justify-center font-bold shadow-md border border-white/20 animate-bounce">{quoteItems.reduce((a, b) => a + b.quantity, 0)}</span>}
                            {/* Additional glow layer for dark mode */}
                            {theme === Theme.DARK && (
                                <div className="absolute inset-0 bg-orange-500 opacity-20 blur-xl rounded-full animate-pulse pointer-events-none"></div>
                            )}
                        </div>
                    </button>
                    <OpacityToggle value={opacityLevel} onChange={setOpacityLevel} currentTheme={theme} />
                    <ThemeToggle currentTheme={theme} onToggle={() => setTheme((t) => (t === Theme.LIGHT ? Theme.DARK : Theme.LIGHT))} />
                </div>
            );
        };

        const App = () => {
            const INITIAL_CARDS = [
                { id: 'lightbox', title: 'LIGHTBOX', rateKey: 'LIGHTBOX_ONLY', priceKey: 'lightboxOnly', theme: 'orange', suffix: '/SQ FT' },
                { id: 'lightbox_backlit', title: 'LIGHTBOX W BACKLIT', rateKey: 'LIGHTBOX_W_BACKLIT', priceKey: 'lightboxBacklit', theme: 'red', suffix: '/SQ FT' },
                { id: 'backlit', title: 'BACKLIT', rateKey: 'BACKLIT_ONLY', priceKey: 'backlitOnly', theme: 'blue', suffix: '/SQ FT' },
                { id: 'trans', title: 'TRANS', rateKey: 'TRANS_ONLY', priceKey: 'transOnly', theme: 'indigo', suffix: '/SQ FT' },
                { id: 'printed3d', title: '3D PRINTED', rateKey: 'PRINTED_3D', priceKey: 'printed3d', theme: 'yellow', suffix: '/SQ FT' },
                { id: 'vinyl', title: 'VINYL STICKER', rateKey: 'VINYL_STD', priceKey: 'vinylStd', theme: 'purple', suffix: '/SQ FT' },
                { id: 'led', title: 'LED STRIP', rateKey: '', priceKey: 'ledStrip', theme: 'green', suffix: '/M FORMULA', isFixed: true },
                { id: 'acrylic', title: 'ACRYLIC', rateKey: 'ACRYLIC', priceKey: 'acrylic', theme: 'cyan', suffix: '/SQ FT' },
            ];

            const [theme, setTheme] = useState(Theme.DARK);
            const [unit, setUnit] = useState(Unit.IN);
            const [width, setWidth] = useState('120');
            const [height, setHeight] = useState('36');
            
            const [modalOpen, setModalOpen] = useState(false);
            const [modalData, setModalData] = useState(null);
            const [quoteItems, setQuoteItems] = useState([]);
            const [quoteListOpen, setQuoteListOpen] = useState(false);
            
            const [opacityLevel, setOpacityLevel] = useState(0.5);
            const [rates, setRates] = useState({...RATES});

            // Reorder State
            const [cards, setCards] = useState(INITIAL_CARDS);
            const [isReordering, setIsReordering] = useState(false);
            const [draggedItemIndex, setDraggedItemIndex] = useState(null);
            const containerRef = useRef(null);

            useEffect(() => {
                const saved = localStorage.getItem('theme');
                if (saved === Theme.DARK || saved === Theme.LIGHT) {
                    setTheme(saved);
                } else {
                    setTheme(Theme.DARK);
                }
            }, []);

            useEffect(() => {
                document.documentElement.classList.toggle('dark', theme === Theme.DARK);
                document.documentElement.classList.toggle('light', theme === Theme.LIGHT);
                localStorage.setItem('theme', theme);
            }, [theme]);

            const calculations = useMemo(() => calculatePrices(parseFloat(width) || 0, parseFloat(height) || 0, unit, rates), [width, height, unit, rates]);
            const { prices, dimensions } = calculations;

            const handleOpenQuote = (title, price, colorTheme) => {
                const widthVal = parseFloat(width); 
                const heightVal = parseFloat(height);
                
                if (widthVal <= 0 || heightVal <= 0) setModalData(null);
                else {
                    setModalData({
                        id: Date.now().toString(),
                        timestamp: Date.now(),
                        title, 
                        totalPrice: price, 
                        widthInches: dimensions.w_in, 
                        heightInches: dimensions.h_in, 
                        unit, 
                        originalWidth: widthVal, 
                        originalHeight: heightVal, 
                        colorTheme,
                        quantity: 1
                    });
                }
                setModalOpen(true);
            };

            const handleAddToQuote = () => {
                if (!modalData) return;
                setQuoteItems((p) => [...p, { ...modalData, id: Date.now().toString(), timestamp: Date.now(), quantity: 1 }]);
                setModalOpen(false); 
                setQuoteListOpen(true);
            };

            const handleUpdateQuantity = (id, delta) => {
                setQuoteItems((prev) => prev.map((item) => { if (item.id === id) { const newQuantity = Math.max(1, item.quantity + delta); return { ...item, quantity: newQuantity }; } return item; }));
            };

            const handleRemoveItem = (id) => setQuoteItems((p) => p.filter((i) => i.id !== id));
            const handleClearAll = () => setQuoteItems([]);
            const handleAddCustomItem = (item) => setQuoteItems((p) => [...p, item]);
            const handleUpdateItem = (id, updates) => setQuoteItems((p) => p.map((i) => (i.id === id ? { ...i, ...updates } : i)));
            
            // Add handler for reordering items
            const handleReorderItems = (newItems) => setQuoteItems(newItems);

            const updateRate = (key, value) => setRates(prev => ({ ...prev, [key]: value }));

            // Interaction Handlers
            const handleInteraction = (cardId, type) => {
                if (type === 'longpress') {
                    setIsReordering(true);
                } else if (type === 'click') {
                    if (!isReordering) {
                        const card = cards.find(c => c.id === cardId);
                        if (card) handleOpenQuote(card.title, prices[card.priceKey], card.theme);
                    }
                }
            };

            // Desktop Drag and Drop
            const handleDragStart = (e, index) => {
                if (!isReordering) {
                    e.preventDefault();
                    return;
                }
                setDraggedItemIndex(index);
                // Required for Firefox
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', index.toString());
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                if (draggedItemIndex === null || draggedItemIndex === index) return;

                const newCards = [...cards];
                const draggedItem = newCards[draggedItemIndex];
                newCards.splice(draggedItemIndex, 1);
                newCards.splice(index, 0, draggedItem);
                setCards(newCards);
                setDraggedItemIndex(index);
            };

            const handleDragEnd = () => {
                setDraggedItemIndex(null);
            };

            // Mobile Touch Drag and Drop (Simulated)
            const handleTouchStart = (e, index) => {
                if (!isReordering) return;
                setDraggedItemIndex(index);
            };

            const handleContainerTouchMove = (e) => {
                if (!isReordering || draggedItemIndex === null) return;
                
                // Prevent default to avoid scrolling while rearranging
                if (e.cancelable) e.preventDefault();

                const touch = e.touches[0];
                const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);
                
                // Find the closest card element from the touch target
                const cardElement = targetElement?.closest('[data-card-index]');
                
                if (cardElement) {
                    const targetIndex = parseInt(cardElement.getAttribute('data-card-index') || '-1', 10);
                    
                    if (targetIndex !== -1 && targetIndex !== draggedItemIndex) {
                        const newCards = [...cards];
                        const draggedItem = newCards[draggedItemIndex];
                        newCards.splice(draggedItemIndex, 1);
                        newCards.splice(targetIndex, 0, draggedItem);
                        
                        setCards(newCards);
                        setDraggedItemIndex(targetIndex);
                    }
                }
            };

            const handleTouchEnd = () => {
                setDraggedItemIndex(null);
            };

            const closeReordering = () => {
                setIsReordering(false);
                setDraggedItemIndex(null);
            };

            const RateInput = ({ value, onChange, suffix }) => {
                const [localValue, setLocalValue] = useState(value.toString());

                useEffect(() => { setLocalValue(value.toString()); }, [value]);

                const handleChange = (e) => {
                    const val = e.target.value;
                    setLocalValue(val);
                    const num = parseFloat(val);
                    if (!isNaN(num)) onChange(num);
                };

                return (
                    <div className="inline-flex items-center bg-white/40 dark:bg-zinc-800/80 rounded-md px-1.5 py-0.5 border border-white/20 dark:border-zinc-600 hover:border-white/40 dark:hover:border-zinc-500 transition-colors cursor-text pointer-events-auto shadow-sm" onPointerDown={(e) => e.stopPropagation()} onClick={(e) => e.stopPropagation()}>
                        <span className="text-gray-700 dark:text-gray-400 font-bold mr-0.5">$</span>
                        <input type="number" value={localValue} onChange={handleChange} className="w-14 sm:w-20 bg-transparent outline-none text-center font-bold text-gray-900 dark:text-gray-100 p-0 m-0 border-none appearance-none" style={{ MozAppearance: 'textfield' }} />
                        {suffix && <span className="text-gray-700 dark:text-gray-400 font-medium ml-1 whitespace-nowrap">{suffix}</span>}
                    </div>
                );
            };

            return (
                <div className="flex flex-col min-h-screen relative overflow-hidden bg-gray-200 dark:bg-dark-bg transition-colors duration-700 font-sans">
                    <TouchRipple />
                    <BackgroundEffects />
                    
                    {/* Global overlay to exit reordering */}
                    {isReordering && (
                        <div className="fixed inset-0 z-0 bg-black/10 md:backdrop-blur-[1px] animate-fade-in" onClick={closeReordering} />
                    )}

                    <header className="fixed top-0 z-40 w-full h-20 flex items-center justify-between px-6 sm:px-10 pointer-events-none">
                        {isReordering && (
                            <button 
                                onClick={closeReordering} 
                                className="fixed top-6 right-6 sm:right-10 z-50 bg-blue-600 text-white px-6 py-2 rounded-full font-bold shadow-md md:shadow-lg animate-fade-in md:hover:bg-blue-700 md:hover:scale-105 active:scale-95 pointer-events-auto flex items-center gap-2"
                            >
                                <Check className="w-5 h-5" /> Done
                            </button>
                        )}
                    </header>

                    <div className={`hidden lg:flex fixed right-6 top-1/2 -translate-y-1/2 flex-col gap-4 z-50 animate-fade-in pointer-events-auto items-end transition-opacity duration-300 ${isReordering ? 'opacity-30 pointer-events-none' : 'opacity-100'}`}>
                        <ControlGroup quoteItems={quoteItems} setQuoteListOpen={setQuoteListOpen} setOpacityLevel={setOpacityLevel} opacityLevel={opacityLevel} theme={theme} setTheme={setTheme} className="flex-col gap-4" />
                    </div>

                    <main className="flex-grow flex items-center justify-center p-2 sm:p-4 md:p-8 relative z-10 mt-2 sm:mt-10">
                        <div className="w-full max-w-6xl">
                            {/* Signboard Glow Effect */}
                            <div className="absolute inset-0 -m-8 sm:-m-12 md:-m-16 bg-gradient-to-br from-yellow-400/40 via-cyan-300/30 to-yellow-300/20 blur-3xl rounded-full opacity-60 -z-10"></div>
                            
                            <div className="w-full rounded-3xl border-4 border-white/80 overflow-hidden ring-2 ring-yellow-400/50 flex flex-col items-center bg-gradient-to-br from-white via-yellow-50/90 to-cyan-50/80 dark:from-zinc-900 dark:via-yellow-950/30 dark:to-cyan-950/20 shadow-[0_0_80px_rgba(250,204,21,0.4)] dark:shadow-[0_0_60px_rgba(193,216,47,0.3)] relative" style={{ '--tw-bg-opacity': opacityLevel }}>
                                {/* Inner Frame Border */}
                                <div className="absolute inset-0 pointer-events-none rounded-[26px] border-2 border-yellow-200/40 dark:border-yellow-400/20 m-2"></div>
                                
                                <div className="w-full px-4 sm:px-8 pt-8 sm:pt-10 pb-4 flex items-center justify-between lg:justify-center gap-2 sm:gap-4 relative overflow-hidden sm:overflow-visible">
                                    <div className="min-w-0 flex-1 lg:flex-none">
                                        <h1 className="text-xl sm:text-3xl md:text-4xl font-black font-mono text-green-600 dark:text-[#C1D82F] drop-shadow-lg dark:drop-shadow-[0_0_15px_rgba(193,216,47,0.5)] tracking-widest sm:tracking-[0.25em] uppercase sm:whitespace-nowrap lg:overflow-visible transition-all duration-500" style={{ textShadow: '3px 3px 0px rgba(34,197,94,0.3), 6px 6px 0px rgba(0,0,0,0.2), 0px 0px 15px rgba(34,197,94,0.3)', transform: 'perspective(600px) rotateX(5deg) rotateY(-3deg)', transformStyle: 'preserve-3d' }}>
                                            PRICING CALCULATOR
                                        </h1>
                                    </div>
                                    <div className={`flex lg:hidden items-center gap-2 sm:gap-3 ml-auto shrink-0 z-20 transition-opacity duration-300 ${isReordering ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
                                        <ControlGroup quoteItems={quoteItems} setQuoteListOpen={setQuoteListOpen} setOpacityLevel={setOpacityLevel} opacityLevel={opacityLevel} theme={theme} setTheme={setTheme} className="gap-2 sm:gap-3" />
                                    </div>
                                </div>

                                <div className="px-6 pb-8 w-full flex flex-col items-center">
                                    {/* Input Section - Enhanced with signboard styling */}
                                    <div className={`w-full flex flex-col lg:flex-row gap-3 mb-8 items-stretch justify-center bg-gradient-to-br from-yellow-100/40 to-cyan-100/30 dark:from-yellow-900/20 dark:to-cyan-900/15 p-4 rounded-2xl border-2 border-yellow-300/50 dark:border-yellow-600/40 shadow-[inset_0_2px_8px_rgba(250,204,21,0.1)] transition-opacity duration-300 ${isReordering ? 'opacity-40 grayscale pointer-events-none' : 'opacity-100'}`}>
                                        <div className="flex flex-row gap-2 w-full lg:w-auto items-stretch p-1 lg:p-2 shrink-0">
                                            <div className="flex-1 flex flex-col items-center justify-center bg-gradient-to-br from-red-500/10 via-red-400/8 to-pink-400/8 dark:from-red-500/12 dark:via-red-400/10 dark:to-pink-400/8 md:backdrop-blur-xl saturate-150 rounded-lg px-2 sm:px-4 py-2 border-2 border-red-600/60 dark:border-red-500/50 shadow-[0_2px_8px_0_rgba(220,38,38,0.02)] md:shadow-[0_4px_16px_0_rgba(220,38,38,0.04)] dark:shadow-[0_2px_8px_0_rgba(220,38,38,0.04)] md:dark:shadow-[0_4px_16px_0_rgba(220,38,38,0.06)] min-w-0 md:min-w-[160px] relative group focus-within:ring-2 focus-within:ring-red-500/30 overflow-hidden md:hover:bg-red-400/12 dark:md:hover:bg-red-400/15">
                                                <div className="hidden md:block absolute inset-0 bg-gradient-to-br from-transparent via-red-500/3 to-transparent dark:via-red-500/5 bg-[length:200%_200%] animate-gradient-x pointer-events-none opacity-50 mix-blend-overlay" style={{ animationDuration: '8s' }} />
                                                <div className="absolute inset-0 bg-gradient-to-br from-red-400/10 dark:from-red-500/8 via-transparent to-transparent opacity-50 dark:opacity-20 pointer-events-none md:group-hover:opacity-70 md:dark:group-hover:opacity-30" />
                                                <span className="relative z-10 text-[9px] text-red-600 dark:text-red-400 font-bold tracking-widest uppercase mb-1 whitespace-nowrap drop-shadow-sm">INPUT SIZE</span>
                                                <div className="relative z-10 flex items-center justify-center gap-1 sm:gap-2 w-full">
                                                    <input type="number" step="0.001" value={width} onChange={(e) => setWidth(e.target.value)} className="w-24 sm:w-32 text-center bg-transparent border-b border-red-400/20 dark:border-red-500/25 text-gray-900 dark:text-white text-base sm:text-lg font-bold font-mono focus:outline-none focus:border-red-500 dark:focus:border-red-400 p-0 placeholder-gray-400 dark:placeholder-gray-600" placeholder="W" />
                                                    <span className="text-gray-400 text-xs sm:text-sm font-light"></span>
                                                    <input type="number" step="0.001" value={height} onChange={(e) => setHeight(e.target.value)} className="w-24 sm:w-32 text-center bg-transparent border-b border-red-400/20 dark:border-red-500/25 text-gray-900 dark:text-white text-base sm:text-lg font-bold font-mono focus:outline-none focus:border-red-500 dark:focus:border-red-400 p-0 placeholder-gray-400 dark:placeholder-gray-600" placeholder="H" />
                                                </div>
                                            </div>

                                            <div className="relative group w-20 sm:w-32 min-h-[60px] shrink-0 bg-gradient-to-br from-red-500/10 via-red-400/8 to-pink-400/8 dark:from-red-500/12 dark:via-red-400/10 dark:to-pink-400/8 md:backdrop-blur-xl saturate-150 rounded-lg border-2 border-red-600/60 dark:border-red-500/50 shadow-[0_2px_8px_0_rgba(220,38,38,0.02)] md:shadow-[0_4px_16px_0_rgba(220,38,38,0.04)] md:dark:shadow-[0_4px_16px_0_rgba(220,38,38,0.06)] overflow-hidden md:hover:bg-red-400/12 md:dark:hover:bg-red-400/15">
                                                <div className="hidden md:block absolute inset-0 bg-gradient-to-br from-transparent via-red-500/3 to-transparent dark:via-red-500/5 bg-[length:200%_200%] animate-gradient-x pointer-events-none opacity-50 mix-blend-overlay" style={{ animationDuration: '8s' }} />
                                                <div className="absolute inset-0 bg-gradient-to-br from-red-400/10 dark:from-red-500/8 via-transparent to-transparent opacity-50 dark:opacity-20 pointer-events-none md:group-hover:opacity-70 md:dark:group-hover:opacity-30" />
                                                <select value={unit} onChange={(e) => setUnit(e.target.value)} className="relative z-10 w-full h-full appearance-none bg-transparent px-2 sm:px-4 text-xs sm:text-sm font-bold text-red-600 dark:text-red-400 focus:outline-none focus:ring-2 focus:ring-red-500/30 cursor-pointer uppercase tracking-wide text-center">
                                                    <option value={Unit.IN} className="text-black bg-white dark:bg-zinc-800 dark:text-white">In</option>
                                                    <option value={Unit.FT} className="text-black bg-white dark:bg-zinc-800 dark:text-white">Ft</option>
                                                    <option value={Unit.CM} className="text-black bg-white dark:bg-zinc-800 dark:text-white">CM</option>
                                                    <option value={Unit.MM} className="text-black bg-white dark:bg-zinc-800 dark:text-white">MM</option>
                                                </select>
                                                <ChevronDown className="absolute right-1 sm:right-3 top-1/2 -translate-y-1/2 w-3 h-3 sm:w-4 sm:h-4 text-red-600 dark:text-red-400 pointer-events-none opacity-70 z-10" />
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 w-full p-1 lg:p-2">
                                            <div className="flex flex-col items-center justify-center bg-gradient-to-br from-blue-400/25 via-blue-300/15 to-cyan-300/15 dark:from-blue-600/30 dark:via-blue-500/20 dark:to-cyan-500/15 rounded-xl px-3 py-3 border-2 border-blue-400/60 dark:border-blue-500/50 shadow-lg shadow-blue-400/20 dark:shadow-blue-500/15 md:backdrop-blur-xl min-w-[90px]">
                                                <span className="text-[10px] text-blue-700 dark:text-blue-200 font-black tracking-wider uppercase mb-2 drop-shadow-md font-mono">INCHES</span>
                                                <div className="flex flex-row md:flex-col items-center justify-center gap-1 md:gap-1 w-full"><span className="text-sm sm:text-base font-mono text-blue-900 dark:text-blue-100 font-black whitespace-nowrap overflow-hidden text-ellipsis max-w-full drop-shadow-md">{dimensions.w_in.toFixed(1)}"</span><span className="text-blue-400/60 text-xs md:hidden"></span><span className="hidden md:block w-10 h-0.5 bg-gradient-to-r from-blue-300 to-blue-400/20 my-1.5 rounded-full"></span><span className="text-sm sm:text-base font-mono text-blue-900 dark:text-blue-100 font-black whitespace-nowrap overflow-hidden text-ellipsis max-w-full drop-shadow-md">{dimensions.h_in.toFixed(1)}"</span></div>
                                            </div>
                                            <div className="flex flex-col items-center justify-center bg-gradient-to-br from-purple-400/25 via-purple-300/15 to-pink-300/15 dark:from-purple-600/30 dark:via-purple-500/20 dark:to-pink-500/15 rounded-xl px-3 py-3 border-2 border-purple-400/60 dark:border-purple-500/50 shadow-lg shadow-purple-400/20 dark:shadow-purple-500/15 md:backdrop-blur-xl min-w-[90px]">
                                                <span className="text-[10px] text-purple-700 dark:text-purple-200 font-black tracking-wider uppercase mb-2 drop-shadow-md font-mono">FEET</span>
                                                <div className="flex flex-row md:flex-col items-center justify-center gap-1 md:gap-1 w-full"><span className="text-sm sm:text-base font-mono text-purple-900 dark:text-purple-100 font-black whitespace-nowrap overflow-hidden text-ellipsis max-w-full drop-shadow-md">{dimensions.w_ft.toFixed(2)}'</span><span className="text-purple-400/60 text-xs md:hidden"></span><span className="hidden md:block w-10 h-0.5 bg-gradient-to-r from-purple-300 to-purple-400/20 my-1.5 rounded-full"></span><span className="text-sm sm:text-base font-mono text-purple-900 dark:text-purple-100 font-black whitespace-nowrap overflow-hidden text-ellipsis max-w-full drop-shadow-md">{dimensions.h_ft.toFixed(2)}'</span></div>
                                            </div>
                                            <div className="flex flex-col items-center justify-center bg-gradient-to-br from-cyan-400/25 via-cyan-300/15 to-teal-300/15 dark:from-cyan-600/30 dark:via-cyan-500/20 dark:to-teal-500/15 rounded-xl px-3 py-3 border-2 border-cyan-400/60 dark:border-cyan-500/50 shadow-lg shadow-cyan-400/20 dark:shadow-cyan-500/15 md:backdrop-blur-xl min-w-[90px]">
                                                <span className="text-[10px] text-cyan-700 dark:text-cyan-200 font-black tracking-wider uppercase mb-2 drop-shadow-md font-mono">CM</span>
                                                <div className="flex flex-row md:flex-col items-center justify-center gap-1 md:gap-1 w-full"><span className="text-sm sm:text-base font-mono text-cyan-900 dark:text-cyan-100 font-black whitespace-nowrap overflow-hidden text-ellipsis max-w-full drop-shadow-md">{dimensions.w_cm.toFixed(0)}</span><span className="text-cyan-400/60 text-xs md:hidden"></span><span className="hidden md:block w-10 h-0.5 bg-gradient-to-r from-cyan-300 to-cyan-400/20 my-1.5 rounded-full"></span><span className="text-sm sm:text-base font-mono text-cyan-900 dark:text-cyan-100 font-black whitespace-nowrap overflow-hidden text-ellipsis max-w-full drop-shadow-md">{dimensions.h_cm.toFixed(0)}</span></div>
                                            </div>
                                            <div className="flex flex-col items-center justify-center bg-gradient-to-br from-yellow-400/25 via-yellow-300/15 to-orange-300/15 dark:from-yellow-600/30 dark:via-yellow-500/20 dark:to-orange-500/15 rounded-xl px-3 py-3 border-2 border-yellow-400/60 dark:border-yellow-500/50 shadow-lg shadow-yellow-400/20 dark:shadow-yellow-500/15 md:backdrop-blur-xl min-w-[90px]">
                                                <span className="text-[10px] text-yellow-700 dark:text-yellow-200 font-black tracking-wider uppercase mb-2 drop-shadow-md font-mono">MM</span>
                                                <div className="flex flex-row md:flex-col items-center justify-center gap-1 md:gap-1 w-full"><span className="text-sm sm:text-base font-mono text-yellow-900 dark:text-yellow-100 font-black whitespace-nowrap overflow-hidden text-ellipsis max-w-full drop-shadow-md">{dimensions.w_mm.toFixed(0)}</span><span className="text-yellow-400/60 text-xs md:hidden"></span><span className="hidden md:block w-10 h-0.5 bg-gradient-to-r from-yellow-300 to-yellow-400/20 my-1.5 rounded-full"></span><span className="text-sm sm:text-base font-mono text-yellow-900 dark:text-yellow-100 font-black whitespace-nowrap overflow-hidden text-ellipsis max-w-full drop-shadow-md">{dimensions.h_mm.toFixed(0)}</span></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div 
                                        ref={containerRef}
                                        className="grid grid-cols-2 md:grid-cols-4 gap-4 w-full auto-rows-fr relative"
                                        onTouchMove={handleContainerTouchMove}
                                        onTouchEnd={handleTouchEnd}
                                    >
                                        {cards.map((card, index) => (
                                            <PricingCard 
                                                key={card.id}
                                                data-card-index={index}
                                                title={card.title} 
                                                rateDescription={
                                                    card.isFixed 
                                                    ? <RateInput value={LED_STRIP_MULTIPLIER} onChange={v => console.log('Fixed LED Rate')} suffix={card.suffix} />
                                                    : <RateInput value={rates[card.rateKey || '']} onChange={v => updateRate(card.rateKey || '', v)} suffix={card.suffix} />
                                                } 
                                                price={prices[card.priceKey]} 
                                                colorTheme={card.theme} 
                                                
                                                isReordering={isReordering}
                                                isDragging={draggedItemIndex === index}
                                                draggable={isReordering}
                                                onDragStart={(e) => handleDragStart(e, index)}
                                                onDragOver={(e) => handleDragOver(e, index)}
                                                onDragEnd={handleDragEnd}
                                                
                                                onTouchStart={(e) => handleTouchStart(e, index)}
                                                
                                                onInteraction={(type) => handleInteraction(card.id, type)}
                                            />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <QuotationModal isOpen={modalOpen} data={modalData} onClose={() => setModalOpen(false)} onAddToQuote={handleAddToQuote} opacityLevel={opacityLevel} />
                        <QuotationList isOpen={quoteListOpen} onClose={() => setQuoteListOpen(false)} items={quoteItems} onRemoveItem={handleRemoveItem} onUpdateQuantity={handleUpdateQuantity} onClearAll={handleClearAll} onAddCustomItem={handleAddCustomItem} onUpdateItem={handleUpdateItem} onReorderItems={handleReorderItems} opacityLevel={opacityLevel} />

                    </main>

                    <footer className="w-full py-8 relative z-10 flex items-center justify-center hidden sm:flex">
                        <p className="text-sm font-mono font-bold tracking-[0.25em] uppercase transition-all duration-500 
                            text-green-700 dark:text-[#C1D82F]
                            drop-shadow-lg dark:drop-shadow-[0_0_10px_rgba(193,216,47,0.4)]
                            cursor-default">
                            &copy; 2026 Halo Design Hub
                        </p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>